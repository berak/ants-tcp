function g(a,b){this.w=a,this.h=b}function h(a,b,c,d){this.x=a,this.y=b,this.w=c,this.h=d}function i(a,b,c){this.obj=a,this.func=b,this.args=c}function j(a){var b,c,d,e,f=a[0],g=a[1]/100,h=a[2]/100,i=(1-Math.abs(2*h-1))*g,j=f/60,k=i*(1-Math.abs(j%2-1));switch(Math.floor(j)){case 0:b=i,c=k,d=0;break;case 1:b=k,c=i,d=0;break;case 2:b=0,c=i,d=k;break;case 3:b=0,c=k,d=i;break;case 4:b=k,c=0,d=i;break;case 5:b=i,c=0,d=k;break;default:b=0,c=0,d=0}return e=h-.5*i,[Math.floor(.999+255*(b+e)),Math.floor(.999+255*(c+e)),Math.floor(.999+255*(d+e))]}function k(a){return"#"+INT_TO_HEX[a[0]]+INT_TO_HEX[a[1]]+INT_TO_HEX[a[2]]}function l(a,b){this.id=a,this.death=undefined,this.keyFrames=[new m],this.keyFrames[0].time=b,this.owner=undefined,this.keyFrameCache=new n(a,this.keyFrames[0]),this.lookup=[]}function m(){this.time=0,this.x=0,this.y=0,this.r=0,this.g=0,this.b=0,this.size=0,this.owner=undefined}function n(a,b){this.antId=a,this.assign(b),this.mapX=this.x,this.mapY=this.y}function o(){this.cleanUp(),this.options=null,this.config=new w}function p(a,b){this.group=a,this.onclick=b,this.hover=!1,this.down=0,this.locked=!1,this.enabled=b?!0:!1}function q(a,b){this.buttons=[],this.manager=a,this.border=b?b:0}function r(a,b,c,d,e){this.upper(a,d),this.idx=b,this.offset=(a.size-2*a.border)*b,this.delta=c,this.hint=e}function s(a,b,c,d,e,f){this.upper(a,e),this.img=b,this.vertical=c,this.mode=d,this.size=b.height+2*this.border,this.x=0,this.y=0,this.w=this.vertical?this.size:f,this.h=this.vertical?f:this.size}function t(a,b,c,d){this.upper(a,d),this.text=b,this.color=c,this.x=0,this.y=0,this.setText(b),this.h=28}function u(a,b,c){this.upper(a,c),this.mode=b,this.x=0,this.y=0,this.h=undefined,this.w=undefined}function v(a){this.ctx=a,this.groups=new Object,this.hover=null,this.pinned=null}function w(){this.load()}function x(a){this.speed=0,this.lastTime=undefined,this.time=0,this.vis=a,this.duration=0,this.defaultSpeed=1,this.stopAt=undefined,this.cpu=a.state.config.cpu,this.onstate=undefined,this.timeout=undefined,this.frameCounter=0,this.frameStart=undefined,this.frameCpu=undefined,this.fixedFpt=undefined}function y(a){this.src=a,this.success=undefined}function z(a,b){this.dataDir=a,this.callback=b,this.info=[],this.images=[],this.patterns=[],this.error="",this.pending=0,this.askSecurity=!0,this.restrictSecurity=!1}function A(a,b){this.x=a,this.y=b,this.angle=Math.atan2(a,-b)}function B(a,b,c){var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F="json",G=undefined;this.debug=b||!1;if(a===undefined)this.meta=new Object,this.meta.challenge="ants",this.meta.replayformat=F,this.meta.replaydata={map:{},ants:[],food:[],hills:[]},this.duration=-1,this.hasDuration=!0,this.aniAnts=[];else{a.search(/^\s*{/)===-1?a=this.txtToJson(a):a=JSON.parse(a),a.challenge===undefined?(this.meta=new Object,this.meta.challenge="ants",this.meta.replayformat=F,this.meta.replaydata=a):(this.meta=a,typeof this.meta.replaydata=="string"&&(F="storage",this.meta.replaydata=this.txtToJson(this.meta.replaydata)),a=this.meta.replaydata);if(this.meta.challenge!=="ants")throw new Error('This visualizer is for the ants challenge, but a "'+this.meta.challenge+'" replay was loaded.');if(this.meta.replayformat!==F)throw new Error('Replays in the format "'+this.meta.replayformat+'" are not supported.');if(!a)throw new Error("replay meta data is no object notation");this.duration=0,l=this;if(a){m=[],n=function(a,b,c){if(a[b]!==c&&!l.debug)throw new Error(m.join(".")+"."+b+" should be "+c+", but was found to be "+a[b]+"!")},o=function(a,b,c,d){if((a[b]<c||a[b]>d&&d!==undefined)&&!l.debug)throw new Error(m.join(".")+"."+b+" should be within ["+c+" .. "+d+"], but was found to be "+a[b]+"!")},p=function(a,b,c,d){if(a[b]instanceof Array)m.push(b),o(a[b],"length",c,d),m.pop();else throw new Error(m.join(".")+"."+b+" should be an array, but was found to be of type "+typeof a[b]+"!")},q=function(a,b,c,d){if(typeof a[b]!="string")throw new Error(m.join(".")+"."+b+" should be a string, but was found to be of type "+typeof a[b]+"!");m.push(b),o(a[b],"length",c,d),m.pop()},r=function(a,b,c,d){a[b]!==undefined&&c.apply(undefined,[a,b].concat(d))},s=function(a,b,c,d,e){a[b]===undefined&&(a[b]=c),d.apply(undefined,[a,b].concat(e))},t=function(a,b){if(a[b]instanceof Object)return m.push(b),a[b];throw new Error(m.join(".")+"."+b+" should be an object, but was found to be of type "+typeof a[b]+"!")},u=null,v=function(a,b){if(u){if(!b&&l.duration<a||b&&l.duration!==a&&!l.debug)throw new Error("Replay duration was previously set to "+l.duration+' by "'+u+'" and is now redefined to be '+a+' by "'+A+'"')}else l.duration=Math.max(l.duration,a),b&&(u=A)},t(this.meta,"replaydata"),o(a,"revision",2,3),this.revision=a.revision,o(a,"players",1,26),this.players=a.players,r(a,"viewradius2",o,[0,undefined]),w=t(a,"map"),p(w,"data",1,undefined),m.push("data"),q(w.data,0,1,undefined),m.pop(),s(w,"rows",w.data.length,n,[w.data.length]),this.rows=w.rows,s(w,"cols",w.data[0].length,n,[w.data[0].length]),this.cols=w.cols,x=t(w,"data"),this.walls=Array(x.length),this.revision<3?k=/[^%*.a-z]/:k=/[^%*.a-zA-Z0-9]/;for(j=0;j<x.length;j++){q(x,j,w.cols,w.cols),y=new String(x[j]);if((d=y.search(k))!==-1&&!this.debug)throw new Error('Invalid character "'+y.charAt(d)+'" in map. Zero based row/col: '+j+"/"+d);this.walls[j]=Array(y.length);for(h=0;h<y.length;h++)this.walls[j][h]=y.charAt(h)==="%"}m.pop(),m.pop();if(this.revision<3)a.hills=[];else{p(a,"hills",0,undefined),m.push("hills"),z=a.hills;for(i=0;i<z.length;i++)p(z,i,4,5),m.push(i),A=z[i],o(A,0,0,w.rows-1),o(A,1,0,w.cols-1),o(A,2,0,this.players-1),o(A,3,0,undefined),v(A[3]-1,!1),A.length>4&&o(A,4,0,this.players-1),m.pop();m.pop()}p(a,"ants",0,undefined),m.push("ants"),B=a.ants,k=/[^nsew-]/;for(i=0;i<B.length;i++){p(B,i,4,7),m.push(i),A=B[i],o(A,0,0,w.rows-1),o(A,1,0,w.cols-1),o(A,2,0,undefined),this.revision>2?e=3:(A[2]===0?o(A,3,0,undefined):o(A,3,A[2]+1,undefined),e=4);if(this.revision<=2&&A.length>4||this.revision>=3){o(A,e,A[e-1]+1,undefined),o(A,e+1,0,this.players-1),C=A[e]-A[e-1],q(A,e+2,C-1,C),v(A[e]-1,A[e+2].length!==C);if((d=A[e+2].search(k))!==-1&&!this.debug)throw new Error('Invalid character "'+A[e+2].charAt(d)+'" in move orders at index '+d+' in the string "'+A[e+2]+'"')}else v(A[3]-1,!1);m.pop()}m.pop();if(this.revision>=3){p(a,"food",0,undefined),m.push("food"),D=a.food;for(i=0;i<D.length;i++)p(D,i,3,5),m.push(i),A=D[i],o(A,0,0,w.rows-1),o(A,1,0,w.cols-1),o(A,2,0,undefined),A.length>3?(o(A,3,A[2]+1,undefined),A.length>4&&o(A,4,0,this.players-1),v(A[3]-1,!1)):v(A[2]-1,!1),m.pop();m.pop()}p(a,"scores",this.players,this.players),m.push("scores"),E=a.scores;for(d=0;d<this.players;d++)v(E[d].length-1,!1);m.pop(),a.bonus&&p(a,"bonus",this.players,this.players);if(this.revision>=3){p(a,"hive_history",this.players,this.players),m.push("hive_history"),G=a.hive_history;for(d=0;d<this.players;d++)v(G[d].length-1,!1);m.pop()}this.turns=Array(this.duration+1),this.scores=Array(this.duration+1),this.counts=Array(this.duration+1),this.stores=Array(this.duration+1),this.fogs=Array(this.players);for(i=0;i<=this.duration;i++){this.scores[i]=Array(this.players),this.counts[i]=Array(this.players),this.stores[i]=Array(this.players);for(d=0;d<this.players;d++)this.counts[i][d]=0}for(d=0;d<this.players;d++){f=E[d];for(e=0;e<f.length;e++)this.scores[e][d]=f[e];for(;e<=this.duration;e++)this.scores[e][d]=f[f.length-1];if(this.revision<3)for(e=0;e<=this.duration;e++)this.stores[e][d]=0;else{player_stores=G[d];for(e=0;e<player_stores.length;e++)this.stores[e][d]=player_stores[e];for(;e<=this.duration;e++)this.stores[e][d]=player_stores[player_stores.length-1]}this.fogs[d]=Array(this.duration+1)}if(this.revision<3){for(d=0;d<B.length;d++)if(B[d][5]!==undefined)for(i=B[d][3];i<B[d][4];i++)this.counts[i][B[d][5]]++}else for(d=0;d<B.length;d++)for(i=B[d][2];i<B[d][3];i++)this.counts[i][B[d][4]]++;this.aniAnts=Array(B.length)}this.hasDuration=this.duration>0||this.meta.replaydata.turns>0,g=undefined,this.meta.user_ids&&(g=this.meta.user_ids.indexOf(c,0),g===-1&&(g=undefined)),this.addMissingMetaData(g)}}function C(a){var b;this.text=a,this.lines=a.replace(C.NORMALIZE_REGEXP,"").split("\n"),this.tokenLines=Array(this.lines.length);for(b=0;b<this.lines.length;b++)this.tokenLines[b]=new D(this.lines[b]);this.pos=0}function D(a){var b;this.line=a,b=a.match(D.KEYWORD_REGEXP),this.keyword=b[1].toLowerCase(),this.params=b[2]}function E(){this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),this.invalid=!0,this.resized=!1,this.x=0,this.y=0,this.w=this.canvas.width,this.h=this.canvas.height,this.dependencies=[],this.invalidates=[]}function F(a){this.upper(),this.state=a,this.water=null}function G(a){this.upper(a),this.scale=1,this.turn=undefined,this.ants=[]}function H(a){this.upper(a)}function I(a){this.upper(),this.state=a,this.player=undefined,this.setSize(2,2)}function J(a,b){this.upper(),this.state=a,this.turn=0,this.shiftX=0,this.shiftY=0,this.scale=1,this.fogMap=null,this.pattern=b,this.dependsOn(b),this.ptrn=null}function K(a,b,c){this.upper(),this.state=a,this.map=b,this.fog=c,this.dependsOn(b),this.dependsOn(c),this.time=0,this.ants=[],this.drawStates=new Object,this.pairing=[],this.scale=1,this.circledAnts=[],this.mouseOverVis=!1,this.mouseCol=0,this.mouseRow=0,this.hillImage=null}function L(a,b){this.upper(),this.state=a,this.antsMap=b,this.dependsOn(b),this.shiftX=0,this.shiftY=0,this.fade=undefined}function M(a,b){this.upper(),this.state=a,this.stats=b,this.duration=0}function N(a,b,c,d){this.upper(),this.state=a,this.caption=b,this.turn=0,this.time=0,this.label=!1,this.bonusText=d,this.graph=new M(a,c),this.dependsOn(this.graph)}function O(a,b){this.values=a,this.bonus=b}var a,b,c,d,e,f;Math.wrapAround=function(a,b){return a-Math.floor(a/b)*b},Math.clamp=function(a,b,c){return a<b?b:a>c?c:a},Math.dist_2=function(a,b,c,d,e,f){var g=Math.abs(a-c),h=Math.abs(b-d);return g=Math.min(g,e-g),h=Math.min(h,f-h),g*g+h*h},a={searchString:function(a){for(var b=0;b<a.length;b++){var c=a[b].string,d=a[b].prop;this.versionSearchString=a[b].versionSearch||a[b].identity;if(c){if(c.indexOf(a[b].subString)!=-1)return a[b].identity}else if(d)return a[b].identity}},searchVersion:function(a){var b=a.indexOf(this.versionSearchString);if(b==-1)return;return parseFloat(a.substring(b+this.versionSearchString.length+1))},dataBrowser:[{string:navigator.userAgent,subString:"Chrome",identity:"Chrome"},{string:navigator.userAgent,subString:"OmniWeb",versionSearch:"OmniWeb/",identity:"OmniWeb"},{string:navigator.vendor,subString:"Apple",identity:"Safari",versionSearch:"Version"},{prop:window.opera,identity:"Opera",versionSearch:"Version"},{string:navigator.vendor,subString:"iCab",identity:"iCab"},{string:navigator.vendor,subString:"KDE",identity:"Konqueror"},{string:navigator.userAgent,subString:"Firefox",identity:"Firefox"},{string:navigator.vendor,subString:"Camino",identity:"Camino"},{string:navigator.userAgent,subString:"Netscape",identity:"Netscape"},{string:navigator.userAgent,subString:"MSIE",identity:"Explorer",versionSearch:"MSIE"},{string:navigator.userAgent,subString:"Gecko",identity:"Mozilla",versionSearch:"rv"}],dataOS:[{string:navigator.platform,subString:"Win",identity:"Windows"},{string:navigator.platform,subString:"Mac",identity:"Mac"},{string:navigator.userAgent,subString:"iPhone",identity:"iPhone/iPod"},{string:navigator.platform,subString:"Linux",identity:"Linux"}],filterNotAny:function(a){var b,c=!1;for(b=0;b<a.length;b++){c=c||this.filter(a[b][0],a[b][1],a[b][2]);if(c)break}return!c},filter:function(a,b,c){return this.browser==a&&this.version==b&&this.system==c},init:function(){this.browser=this.searchString(this.dataBrowser)||"unknown",this.version=this.searchVersion(navigator.userAgent)||this.searchVersion(navigator.appVersion)||"unknown",this.system=this.searchString(this.dataOS)||"unknown"}},a.init(),b={fullImageShadowSupport:a.filterNotAny([["Firefox",5],["Firefox",7,"Windows"],["Chrome",12],["Chrome",13]])},c={LEFT:37,RIGHT:39,SPACE:32,PGUP:33,PGDOWN:34,HOME:36,END:35,PLUS:107,PLUS_OPERA:61,PLUS_JAVA:521,MINUS:109,MINUS_JAVA:45},d={table:function(a){return d.element("table","display:table;width:100%",a)},tr:function(a){return d.element("tr","display:table-row",a)},td:function(a){return d.element("td","display:table-cell;border:dotted 1px;padding:0px 2px",a)},underline:function(a){return d.element("p","text-decoration:underline",a)},bold:function(a){return d.element("p","font-weight:bold",a)},italic:function(a){return d.element("p","display:inline;font-style:italic",a)},element:function(a,b,c){return"<"+a+' style="'+b+'">'+(typeof c=="function"?c():c)+"</"+a+">"}},e={roundedRect:function(a,b,c,d,e,f,g){var h=.5*Math.PI;a.beginPath(),a.moveTo(b+g+f,c+f),a.lineTo(b+d-g-f,c+f),a.arc(b+d-g-f,c+g+f,g,-h,0,!1),a.lineTo(b+d-f,c+e-g-f),a.arc(b+d-g-f,c+e-g-f,g,0,h,!1),a.lineTo(b+g+f,c+e-f),a.arc(b+g+f,c+e-g-f,g,h,2*h,!1),a.lineTo(b+f,c+g+f),a.arc(b+g+f,c+g+f,g,2*h,3*h,!1)}},Function.prototype.extend=function(a){var b,c=undefined;for(c in a.prototype)this.prototype[c]=a.prototype[c];b=function(){a.prototype.upper&&(this.upper=a.prototype.upper),a.apply(this,arguments),delete this.upper},this.prototype.upper=b},h.prototype.contains=function(a,b){return a>=this.x&&a<this.x+this.w&&b>=this.y&&b<this.y+this.h},i.prototype.invoke=function(a){a?this.func.apply(this.obj,a):this.func.apply(this.obj,this.args)},l.prototype.frameAt=function(a){var b,c,d=this.keyFrames;for(c=d.length-1;c>=0;c--){if(d[c].time==a)return d[c];if(d[c].time<a)return b=new m,c===d.length-1?b.assign(d[c]):b.interpolate(d[c],d[c+1],a),b.time=a,d.splice(c+1,0,b),b}return null},l.prototype.interpolate=function(a){var b,c,d,e,f,g,h=this.keyFrames;if(a<h[0].time)return null;e=h[h.length-1];if(a<e.time){f=a|0,g=this.lookup[f];if(g===undefined){if(f<h[0].time)g=0;else{c=0,d=h.length-1;do b=c+d>>1,f<h[b].time?d=b:f>h[b+1].time?c=b:(g=b,this.lookup[f]=b);while(g===undefined)}this.lookup[f]=g}while(a>h[g+1].time)g++;this.keyFrameCache.interpolate(h[g],h[g+1],a)}else this.keyFrameCache.assign(e);return this.keyFrameCache},l.prototype.fade=function(a,b,c,d){var e,f,g,h=this.keyFrames,i=this.frameAt(c),j=this.frameAt(d);for(e=h.length-1;e>=0;e--)if(h[e].time===c)break;f=i[a];for(e++;h[e]!==j;e++)g=(h[e].time-c)/(d-c),h[e][a]=(1-g)*f+g*b;for(;e<h.length;e++)h[e][a]=b},m.prototype.interpolate=function(a,b,c){var d=(c-a.time)/(b.time-a.time),e=1-d;return this.time=e*a.time+d*b.time,this.x=a.x===b.x?a.x:e*a.x+d*b.x,this.y=a.y===b.y?a.y:e*a.y+d*b.y,this.r=e*a.r+d*b.r|0,this.g=e*a.g+d*b.g|0,this.b=e*a.b+d*b.b|0,this.size=e*a.size+d*b.size,this.owner=a.owner,this},m.prototype.assign=function(a){return this.time=a.time,this.x=a.x,this.y=a.y,this.r=a.r,this.g=a.g,this.b=a.b,this.size=a.size,this.owner=a.owner,this},n.extend(m),n.prototype.calcMapCoords=function(a,b,c){this.mapX=Math.round(a*this.x)+a-1,this.mapY=Math.round(a*this.y)+a-1,this.mapX=Math.wrapAround(this.mapX,b)-a+1,this.mapY=Math.wrapAround(this.mapY,c)-a+1},LoadingState={IDLE:0,LOADING:1,CLEANUP:2},Visualizer=function(a,b,c,e,f){var g,h,j,k,l,m,n=undefined,p=this;this.loading=LoadingState.LOADING,this.container=a;while(a.hasChildNodes())a.removeChild(a.lastChild);this.log=document.createElement("div"),this.container.appendChild(this.log);try{this.state=new o,this.map=new H(this.state),this.fogPattern=new I(this.state),this.fog=new J(this.state,this.fogPattern),this.antsMap=new K(this.state,this.map,this.fog),this.shiftedMap=new L(this.state,this.antsMap),this.miniMap=new G(this.state),this.turns=undefined,this.w=c,this.h=e,this.resizing=!1,f&&this.state.config.overrideFrom(f),this.state.options=b,g=window.location.href;if((k=g.indexOf("?"))!==-1){g=g.substr(k+1).split("#")[0].split("&");for(k=0;k<g.length;k++){h=g[k].indexOf("="),n=g[k].substr(0,h),j=g[k].substr(h+1);switch(n){case"debug":this.state.options.debug=Options.toBool(j);break;case"interactive":this.state.options.interactive=Options.toBool(j);break;case"profile":this.state.options.profile=Options.toBool(j);break;case"decorated":this.state.options.decorated=Options.toBool(j);break;case"col":this.state.options.col=parseInt(j);break;case"row":this.state.options.row=parseInt(j);break;case"turn":this.state.options.turn=parseInt(j);break;case"data_dir":this.state.options.data_dir=j;break;case"game":this.state.options.game=j;break;case"user":this.state.options.user=j;break;case"config":this.state.config.overrideFrom(JSON.parse(unescape(j)))}}}!isNaN(this.state.options.row)&&!isNaN(this.state.options.col)&&(this.state.config.zoom=1<<Math.ceil(Math.log(ZOOM_SCALE)/Math.LN2)),m=(this.state.options.data_dir||"")+"img/",this.imgMgr=new z(m,new i(this,this.completedImages)),this.imgMgr.add("water.png"),this.imgMgr.add("hill.png"),this.state.options.decorated&&(this.imgMgr.add("playback.png"),this.imgMgr.add("fog.png"),this.imgMgr.add("toolbar.png"),this.btnMgr=new v(null),this.scores=new N(this.state,"scores","scores","bonus"),this.counts=new N(this.state,"# of ants","counts","hive")),this.director=new x(this),this.mouseX=-1,this.mouseY=-1,this.mouseDown=0,this.mapCenterX=0,this.mapCenterY=0,this.progressList=[],l="Loading visualizer...",l+=d.table(function(){var a,b="",c=undefined;for(c in p.options)a=p.options[c],b+=d.tr(function(){return d.td(function(){return d.bold(c)})+d.td(a)+d.td(function(){var a="<i>";return c==="data_dir"&&(a+="(Image directory)"),a+"</i>"})});return b}),this.log.innerHTML=l,this.replayStr=undefined,this.replayReq=undefined,this.main={},this.hint="",this.loading=LoadingState.IDLE,this.imgMgr.startRequests()}catch(q){throw this.exceptionOut(q,!1),q}},Visualizer.prototype.progress=function(a,b,c){var d,e;if(this.loading!==LoadingState.LOADING)return;for(d=0;d<this.progressList.length;d++)if(c===this.progressList[d])return;this.progressList.push(c),e=this,a&&this.logOut(a),window.setTimeout(function(){var a,d,f,g;try{b();for(a=0;a<e.progressList.length;a++)if(c===e.progressList[a]){e.progressList.splice(a,1);break}}catch(h){e.exceptionOut(h,!0),d=0,f=0,g=e.log;if(g.offsetParent)do d+=g.offsetLeft,f+=g.offsetTop;while(g=g.offsetParent);window.scrollTo(d,f)}},50)},Visualizer.prototype.logOut=function(a){this.log.innerHTML+=a.replace(/\n/g,"<br>")+"<br>"},Visualizer.prototype.errorOut=function(a,b){this.logOut('<font style="color:red">'+a+"</font>"),b&&this.cleanUp()},Visualizer.prototype.exceptionOut=function(a,b){var c,e=undefined;if(typeof a=="string"){this.exceptionOut({message:a},b);return}c="<h4><u>"+(a.name?a.name:"Error")+"</u></h4>",c+=d.table(function(){var b,c="";for(e in a)if(e!=="name")try{b=new String(a[e]),b=b.replace("&","&amp;"),b=b.replace("<","&lt;"),b=b.replace(">","&gt;"),c+=d.tr(function(){return d.td(function(){return d.bold(e)})+d.td(b)})}catch(f){}return c}),this.errorOut(c,b)},Visualizer.prototype.cleanUp=function(){this.loading=LoadingState.CLEANUP,this.replayReq&&this.replayReq.abort(),this.state.options.decorated&&this.imgMgr.cleanUp(),this.director.cleanUp(),this.state.cleanUp(),this.replayStr=undefined,this.replayReq=undefined,this.main.canvas&&this.container.firstChild===this.main.canvas&&this.container.removeChild(this.main.canvas),this.resizing=!1,document.onkeydown=null,document.onkeyup=null,document.onkeypress=null,window.onresize=null,this.log.style.display="block"},Visualizer.prototype.preload=function(){return this.loading!==LoadingState.IDLE?!0:(this.cleanUp(),this.loading=LoadingState.LOADING,!1)},Visualizer.prototype.loadReplayDataFromURI=function(a){var b;if(this.preload())return;b=this,this.progress("Fetching replay from: "+d.italic(String(a))+"...",function(){var c=new XMLHttpRequest;b.replayReq=c,c.onreadystatechange=function(){c.readyState===4&&b.loading===LoadingState.LOADING&&(c.status===200?(b.replayStr=""+c.responseText,b.replayReq=undefined,b.loadParseReplay()):b.errorOut("Status "+c.status+": "+c.statusText,!0))},c.open("GET",a),b.state.options.debug&&c.setRequestHeader("Cache-Control","no-cache"),c.send(),b.loadCanvas()},"FETCH")},Visualizer.prototype.loadReplayData=function(a){if(this.preload())return;this.replayStr=a,this.loadCanvas()},Visualizer.prototype.streamingInit=function(){return this.preload(),this.state.isStreaming=!0,this.state.replay=new B},Visualizer.prototype.streamingStart=function(){this.state.isStreaming=stream.visualizerReady(),this.loading===LoadingState.LOADING?this.state.replay.hasDuration&&(this.director.cpu=1,this.loadCanvas()):(this.resize(!0),resume=!this.director.playing()&&this.state.time===this.director.duration,this.director.stopAt===this.director.duration&&(this.director.stopAt=this.state.replay.duration),this.director.duration=this.state.replay.duration,resume&&this.director.play())},Visualizer.prototype.javaVideoOutput=function(a){this.director.fixedFpt=a},Visualizer.prototype.loadParseReplay=function(){var a=this;this.progress("Parsing the replay...",function(){var b=a.state.options.debug,c=a.state.options.user;c===""&&(c=undefined);if(a.replayStr)a.state.replay=new B(a.replayStr,b,c),a.replayStr=undefined;else if(a.loading!==LoadingState.CLEANUP)throw new Error("Replay is undefined.");a.tryStart()},"PARSE")},Visualizer.prototype.loadCanvas=function(){var a=this;this.progress("Creating canvas...",function(){var b;a.main.canvas||(a.main.canvas=document.createElement("canvas"),a.main.canvas.style.display="none"),b=a.main.canvas,a.main.ctx=b.getContext("2d"),a.container.firstChild!==b&&a.container.insertBefore(b,a.log),a.tryStart()},"CANVAS")},Visualizer.prototype.completedImages=function(a){a?this.errorOut(a,!0):(this.map.water=this.imgMgr.images[0],this.miniMap.water=this.map.water,this.tryStart())},Visualizer.prototype.tryStart=function(){var a,b,c,d,e,f,g=this;if(this.state.replay){if(!this.main.ctx)return;if(this.imgMgr.pending!==0)return;colors=[];for(b=0;b<this.state.replay.players;b++)colors.push(this.state.replay.meta.playercolors[b]);this.imgMgr.colorize(1,colors),this.antsMap.setHillImage(this.imgMgr.patterns[1]);if(this.state.options.decorated){if(this.imgMgr.error)return;if(this.imgMgr.pending)return;this.btnMgr.ctx=this.main.ctx;if(this.state.replay.meta.replaydata.bonus){e=Array(this.state.replay.players);for(b=0;b<this.state.replay.players;b++)e[b]=this.state.replay.scores[this.state.replay.duration][b],e[b]+=this.state.replay.meta.replaydata.bonus[b]}else e=this.state.replay.scores[this.state.replay.duration];this.state.ranks=Array(e.length),this.state.order=Array(e.length);for(b=0;b<e.length;b++){this.state.ranks[b]=1;for(c=0;c<e.length;c++)e[b]<e[c]&&this.state.ranks[b]++;c=this.state.ranks[b]-1;while(this.state.order[c]!==undefined)c++;this.state.order[c]=b}this.state.replay.hasDuration&&this.addPlayerButtons();if(this.state.options.interactive){this.btnMgr.groups.playback||(this.state.replay.hasDuration&&(a=this.btnMgr.addImageGroup("playback",this.imgMgr.images[2],s.HORIZONTAL,q.MODE_NORMAL,2,0),d=new i(this,function(){this.director.gotoTick(0)}),a.addButton(3,d,"jump to start of first turn"),a.addSpace(32),d=new i(this,function(){var a=Math.ceil(this.state.time*2)-1;this.director.slowmoTo(a/2)}),a.addButton(5,d,"play one move/attack phase backwards"),a.addSpace(64),d=new i(this.director,this.director.playStop),a.addButton(4,d,"play/stop the game"),a.addSpace(64),d=new i(this,function(){var a=Math.floor(this.state.time*2)+1;this.director.slowmoTo(a/2)}),a.addButton(6,d,"play one move/attack phase"),a.addSpace(32),d=new i(this,function(){this.director.gotoTick(this.director.duration)}),a.addButton(2,d,"jump to end of the last turn")),a=this.btnMgr.addImageGroup("toolbar",this.imgMgr.images[4],s.VERTICAL,q.MODE_NORMAL,2,0),this.state.config.hasLocalStorage()&&(d=new i(this,function(){this.state.config.save()}),a.addButton(0,d,"save and reuse the current settings")),this.state.options.embedded||(d=new i(this,function(){var a=this.state.config.fullscreen;this.setFullscreen(!a)}),a.addButton(1,d,"toggle fullscreen mode")),d=new i(this,function(){this.setZoom(2*this.state.config.zoom),this.director.draw()}),a.addButton(2,d,"zoom in"),d=new i(this,function(){var a=this.state.scale;do this.setZoom(.5*this.state.config.zoom);while(this.state.scale===a&&this.state.config.zoom>1);this.director.draw()}),a.addButton(3,d,"zoom out"),d=new i(this,this.centerMap),a.addButton(4,d,"center the map").enabled=!1,d=new i(this,function(){var a=this.state.config.label;this.setAntLabels((a+1)%3),this.director.draw()}),a.addButton(5,d,"toggles: 1. player letters on ants, 2. global ids on ants"),this.state.replay.hasDuration&&(d=new i(this,this.modifySpeed,[1]),a.addButton(6,d),d=new i(this,this.modifySpeed,[-1]),a.addButton(7,d),d=new i(this,this.generateBotInput),a.addButton(8,d,"regenerates bot input from this replay")));if(this.state.replay.hasDuration){this.imgMgr.colorize(3,colors),a=this.btnMgr.addImageGroup("fog",this.imgMgr.patterns[3],s.VERTICAL,q.MODE_RADIO,2),f=function(b){var c=new i(g,g.showFog),d="show/clear fog of war for ";return d+=g.state.replay.meta.playernames[b],a.addButton(b,c,d)};for(b=0;b<colors.length;b++)f(this.state.order[b])}}}this.director.duration=this.state.replay.duration,this.calculateReplaySpeed(),this.state.options.interactive&&(this.state.options.decorated&&(this.director.onstate=function(){var a=g.btnMgr.groups.playback.buttons[4];a.offset=(g.director.playing()?7:4)*g.imgMgr.images[2].height,a===g.btnMgr.pinned&&(g.btnMgr.pinned=null),a.down=0,a.draw()}),document.onkeydown=function(a){return!(a.shiftKey||a.ctrlKey||a.altKey||a.metaKey)&&Visualizer.focused.keyPressed(a.keyCode)?(a.preventDefault?a.preventDefault():a.returnValue=!1,!1):!0}),this.main.canvas.onmousemove=function(a){var b=0,c=0,d=this;if(this.offsetParent)do b+=d.offsetLeft,c+=d.offsetTop;while(d=d.offsetParent);b=a.clientX-b+(window.scrollX===undefined?document.body.parentNode.scrollLeft!==undefined?document.body.parentNode.scrollLeft:document.body.scrollLeft:window.scrollX),c=a.clientY-c+(window.scrollY===undefined?document.body.parentNode.scrollTop!==undefined?document.body.parentNode.scrollTop:document.body.scrollTop:window.scrollY),g.mouseMoved(b,c)},this.main.canvas.onmouseout=function(){g.mouseExited()},this.main.canvas.onmousedown=function(a){a.which===1&&(Visualizer.focused=g,g.mousePressed())},this.main.canvas.onmouseup=function(a){a.which===1&&g.mouseReleased()},this.main.canvas.ondblclick=function(){g.shiftedMap.contains(g.mouseX,g.mouseY)&&g.centerMap()},window.onresize=function(){g.resize()},Visualizer.focused=this,this.calculateMapCenter(ZOOM_SCALE),this.state.shiftX=this.mapCenterX,this.state.shiftY=this.mapCenterY,this.log.style.display="none",this.main.canvas.style.display="inline",this.loading=LoadingState.IDLE,this.setFullscreen(this.state.config.fullscreen),this.state.replay.hasDuration&&(isNaN(this.state.options.turn)?this.director.play():this.director.gotoTick(this.state.options.turn-1))}else this.replayStr&&this.loadParseReplay()},Visualizer.prototype.centerMap=function(){var a;this.state.shiftX=this.mapCenterX,this.state.shiftY=this.mapCenterY,this.state.options.decorated&&(a=this.btnMgr.groups.toolbar.getButton(4),a.enabled=!1,a.draw()),this.director.draw()},Visualizer.prototype.modifySpeed=function(a){this.state.config.speedFactor+=a,this.calculateReplaySpeed()},Visualizer.prototype.calculateMapCenter=function(a){var b=this.state.options,c=this.state.replay.cols,d=this.state.replay.rows;!isNaN(b.row)&&!isNaN(b.col)?(this.mapCenterX=a*(.5*c-.5-b.col%c),this.mapCenterY=a*(.5*d-.5-b.row%d)):(this.mapCenterX=0,this.mapCenterY=0)},Visualizer.prototype.addPlayerButtons=function(){var a,b,c=this.btnMgr.addTextGroup("players",q.MODE_NORMAL,2),d=this,e=undefined,f=this.state.replay.meta.game_id;f===undefined&&this.state.options.game&&(f=this.state.options.game),f===undefined?c.addButton("Players:","#000",undefined):(this.state.replay.meta.game_url&&(e=new i(this,function(){window.location.href=this.state.replay.meta.game_url.replace("~",f)})),c.addButton("Game #"+f+":","#000",e)),b=function(a){var b=d.state.replay.htmlPlayerColors[a],e=undefined;d.state.replay.meta.user_url&&d.state.replay.meta.user_ids&&d.state.replay.meta.user_ids[a]!==undefined&&(e=new i(d,function(){window.location.href=this.state.replay.meta.user_url.replace("~",this.state.replay.meta.user_ids[a])})),c.addButton("",b,e)};for(a=0;a<this.state.replay.players;a++)b(this.state.order[a]);this.updatePlayerButtonText()},Visualizer.prototype.calculateReplaySpeed=function(){var a,b,c,d=this.director.duration/this.state.config.duration;d=Math.max(d,this.state.config.speedSlowest),d=Math.min(d,this.state.config.speedFastest),this.director.defaultSpeed=d*Math.pow(1.5,this.state.config.speedFactor),this.director.speed!==0&&(this.director.speed=this.director.defaultSpeed),a=function(a){return"set speed modifier to "+(a>0?"+"+a:a)},this.state.options.interactive&&this.state.options.decorated&&this.state.replay.hasDuration&&(b=this.btnMgr.groups.toolbar.getButton(6),b.hint=a(this.state.config.speedFactor+1),c=this.btnMgr.groups.toolbar.getButton(7),c.hint=a(this.state.config.speedFactor-1))},Visualizer.prototype.calculateCanvasSize=function(){var a,b,c=this.state.options.embedded;return c=c||!this.state.config.fullscreen,a=this.w&&c?this.w:window.innerWidth,b=this.h&&c?this.h:window.innerHeight,new g(a,b)},Visualizer.prototype.setFullscreen=function(a){var b,c;if(!this.state.options.embedded)if(window.setFullscreen)this.state.config.fullscreen=window.setFullscreen(a);else{this.state.config.fullscreen=a;if(a||this.savedBody)b=document.getElementsByTagName("html")[0],a?(this.container.removeChild(this.main.canvas),this.savedOverflow=b.style.overflow,b.style.overflow="hidden",c=document.createElement("body"),c.appendChild(this.main.canvas),this.savedBody=b.replaceChild(c,document.body)):this.savedBody&&(document.body.removeChild(this.main.canvas),this.container.appendChild(this.main.canvas),b.replaceChild(this.savedBody,document.body),b.style.overflow=this.savedOverflow,delete this.savedBody)}this.resize(!0)},Visualizer.prototype.setZoom=function(a){var b,c,d=this.state.scale,e=Math.max(1,a);this.director.fixedFpt===undefined?(this.state.config.zoom=e,this.state.scale=Math.max(1,Math.min((this.shiftedMap.w-20)/this.state.replay.cols,(this.shiftedMap.h-20)/this.state.replay.rows))|0,this.state.scale=Math.min(ZOOM_SCALE,this.state.scale*e)):(this.state.scale=Math.max(1,Math.min(this.shiftedMap.w/this.state.replay.cols,this.shiftedMap.h/this.state.replay.rows))|0,this.state.scale=Math.pow(2,Math.log(this.state.scale)/Math.LN2|0)),d&&(this.state.shiftX=this.state.shiftX*this.state.scale/d|0,this.state.shiftY=this.state.shiftY*this.state.scale/d|0),this.calculateMapCenter(this.state.scale),this.map.setSize(this.state.scale*this.state.replay.cols,this.state.scale*this.state.replay.rows),this.map.x=(this.shiftedMap.w-this.map.w>>1)+this.shiftedMap.x|0,this.map.y=(this.shiftedMap.h-this.map.h>>1)+this.shiftedMap.y|0,this.antsMap.setSize(this.map.w,this.map.h),this.fog.setSize(Math.min(this.map.w,this.shiftedMap.w),Math.min(this.map.h,this.shiftedMap.h)),this.state.options.interactive&&this.state.options.decorated&&(b=this.btnMgr.groups.toolbar.getButton(2),b.enabled=this.state.scale!==ZOOM_SCALE,b.draw(),c=this.btnMgr.groups.toolbar.getButton(3),c.enabled=e!==1,c.draw())},Visualizer.prototype.setAntLabels=function(a){var b=this.state.replay.hasDuration,c=b&&a===1!=(this.state.config.label===1);this.state.config.label=a,c&&(this.updatePlayerButtonText(),this.main.ctx.fillStyle="#fff",this.main.ctx.fillRect(0,0,this.main.canvas.width,this.main.canvas.height),this.resize(!0))},Visualizer.prototype.updatePlayerButtonText=function(){var a,b,c,d=this.btnMgr.getGroup("players");for(a=0;a<this.state.replay.players;a++)b=this.state.order[a],c=this.state.replay.meta.playernames[b],this.state.config.label===1?c=String.fromCharCode(945+a)+" "+c:c=this.state.ranks[b]+". "+c,d.buttons[a+1].setText(c)},Visualizer.prototype.resize=function(a){var b,c,d,e,h,i=new g(this.main.canvas.width,this.main.canvas.height),j=this.calculateCanvasSize(),k=j.w!=i.w||j.h!=i.h;if(k||a)d=this.main.canvas,e=this.main.ctx,k&&(d.width=j.w,d.height=j.h,e.fillStyle="#fff",e.fillRect(0,0,d.width,d.height)),this.resizing=!0,this.state.replay.hasDuration&&this.state.options.decorated?(b=this.btnMgr.groups.players.cascade(j.w)+4,this.scores.x=0,this.scores.y=b,this.scores.setSize(j.w,N.MIN_HEIGHT),this.counts.x=0,this.counts.y=this.scores.y+this.scores.h+4,this.counts.setSize(j.w,N.MAX_HEIGHT),b=this.counts.y+this.counts.h):b=0,this.state.options.interactive&&this.state.options.decorated?(this.state.replay.hasDuration?(this.shiftedMap.x=f,this.shiftedMap.y=b,this.shiftedMap.setSize(j.w-f-RIGHT_PANEL_W,j.h-b-BOTTOM_PANEL_H),h=this.btnMgr.groups.playback,c=512,h.x=(j.w-c)/2|0,h.x=Math.min(h.x,
this.shiftedMap.x+this.shiftedMap.w-c),h.x=Math.max(h.x,0),h.y=this.shiftedMap.y+this.shiftedMap.h,h=this.btnMgr.groups.fog,h.y=this.shiftedMap.y+8):(this.shiftedMap.x=0,this.shiftedMap.y=b,this.shiftedMap.setSize(j.w-RIGHT_PANEL_W,j.h-b)),h=this.btnMgr.groups.toolbar,h.x=this.shiftedMap.x+this.shiftedMap.w,h.y=this.shiftedMap.y+8,this.state.replay.hasDuration&&(h=this.btnMgr.groups.fog,h.h=j.h-this.shiftedMap.y-8,h=this.btnMgr.groups.playback,h.w=this.shiftedMap.x+this.shiftedMap.w-h.x),h=this.btnMgr.groups.toolbar,h.h=j.h-this.shiftedMap.y-8):(this.shiftedMap.x=0,this.shiftedMap.y=b,this.shiftedMap.setSize(j.w,j.h-b)),this.setZoom(this.state.config.zoom),this.miniMap.x=this.shiftedMap.x+this.shiftedMap.w-2-this.state.replay.cols,this.miniMap.y=this.shiftedMap.y+2,this.miniMap.setSize(this.state.replay.cols,this.state.replay.rows),this.state.options.decorated&&this.btnMgr.draw(),this.director.draw(!0),this.resizing=!1},Visualizer.prototype.showFog=function(a){this.state.fogPlayer=a,this.director.draw()},Visualizer.prototype.draw=function(){var a,b,c,d,e,f,g,h,i,j=this.shiftedMap;this.shiftedMap.validate(),this.main.ctx.drawImage(this.shiftedMap.canvas,j.x,j.y),a=this.main.ctx;if(this.state.mouseOverVis){a.save(),a.beginPath(),a.rect(j.x,j.y,j.w,j.h),a.clip(),d=this.mouseX-this.map.x-this.state.shiftX,e=this.mouseY-this.map.y-this.state.shiftY,d=Math.floor(d/this.state.scale)*this.state.scale+this.map.x+this.state.shiftX,e=Math.floor(e/this.state.scale)*this.state.scale+this.map.y+this.state.shiftY,d-=j.x-this.state.scale+1,e-=j.y-this.state.scale+1,d=Math.wrapAround(d,this.map.w),e=Math.wrapAround(e,this.map.h),d+=j.x-this.state.scale+1,e+=j.y-this.state.scale+1,a.strokeStyle="#fff",a.beginPath();for(g=e;g<j.y+j.h;g+=this.map.h)for(f=d;f<j.x+j.w;f+=this.map.w)a.rect(f+.5,g+.5,this.state.scale-1,this.state.scale-1);a.stroke(),a.restore()}this.state.config.zoom!==1&&this.miniMap.h+4<=j.h&&this.miniMap.w+4<=j.w&&(this.miniMap.validate(),a.save(),a.strokeStyle="#fff",a.lineWidth=2,a.beginPath(),a.rect(this.miniMap.x-1,this.miniMap.y-1,this.miniMap.w+2,this.miniMap.h+2),a.stroke(),a.drawImage(this.miniMap.canvas,this.miniMap.x,this.miniMap.y),a.beginPath(),a.rect(this.miniMap.x,this.miniMap.y,this.miniMap.w,this.miniMap.h),a.clip(),b=j.w/this.state.scale,c=j.h/this.state.scale,f=this.state.replay.cols/2-this.state.shiftX/this.state.scale-b/2,g=this.state.replay.rows/2-this.state.shiftY/this.state.scale-c/2,f-=Math.floor(f/this.state.replay.cols)*this.state.replay.cols,g-=Math.floor(g/this.state.replay.rows)*this.state.replay.rows,a.beginPath(),a.rect(this.miniMap.x+f,this.miniMap.y+g,b,c),a.rect(this.miniMap.x+f-this.state.replay.cols,this.miniMap.y+g,b,c),a.rect(this.miniMap.x+f,this.miniMap.y+g-this.state.replay.rows,b,c),a.rect(this.miniMap.x+f-this.state.replay.cols,this.miniMap.y+g-this.state.replay.rows,b,c),a.stroke(),a.restore()),this.state.replay.hasDuration&&this.state.options.decorated&&((this.scores.validate()||this.resizing)&&a.drawImage(this.scores.canvas,this.scores.x,this.scores.y),(this.counts.validate()||this.resizing)&&a.drawImage(this.counts.canvas,this.counts.x,this.counts.y)),h=this.hint;if(h){a.font=FONT,a.textAlign="left",a.textBaseline="middle";if(a.measureText(h).width>j.w){do h=h.substr(0,h.length-1);while(h&&a.measureText(h+"...").width>j.w);h&&(h+="...")}b=a.measureText(h).width,a.fillStyle="rgba(0,0,0,0.3)",a.fillRect(j.x,j.y,b,22),a.fillStyle="#fff",a.fillText(h,j.x,j.y+10)}this.state.isStreaming?(i=this,window.setTimeout(function(){i.state.isStreaming&&i.streamingStart()},0)):this.director.fixedFpt!==undefined&&video.captureFrame(this.director.time,this.director.duration)},Visualizer.prototype.mouseMoved=function(a,b){var c,d,e=a-this.mouseX,f=b-this.mouseY,g=this.hint,h=null;this.mouseX=a,this.mouseY=b,this.state.mouseCol=Math.wrapAround(a-this.map.x-this.state.shiftX,this.state.scale*this.state.replay.cols)/this.state.scale|0,this.state.mouseRow=Math.wrapAround(b-this.map.y-this.state.shiftY,this.state.scale*this.state.replay.rows)/this.state.scale|0,this.hint="";if(this.state.options.interactive){if(this.state.mouseOverVis=this.map.contains(this.mouseX,this.mouseY)&&this.shiftedMap.contains(this.mouseX,this.mouseY))this.hint="row "+this.state.mouseRow+" | col "+this.state.mouseCol;this.mouseDown===1?(c=this.mouseX-this.scores.graph.x,c/=this.scores.graph.w-1,c=Math.round(c*this.state.replay.duration),this.director.gotoTick(c)):this.mouseDown===2||this.mouseDown===3&&this.miniMap.contains(this.mouseX,this.mouseY)?(this.mouseDown===2?(this.state.shiftX+=e,this.state.shiftY+=f):(this.state.shiftX=(this.state.replay.cols/2-(this.mouseX-this.miniMap.x))*this.state.scale,this.state.shiftY=(this.state.replay.rows/2-(this.mouseY-this.miniMap.y))*this.state.scale),this.state.options.decorated&&(d=this.btnMgr.groups.toolbar.getButton(4),d.enabled=this.state.shiftX!==0||this.state.shiftY!==0,d.draw()),this.director.draw()):this.state.options.decorated&&(h=this.btnMgr.mouseMove(a,b))}else this.state.options.decorated&&(h=this.btnMgr.mouseMove(a,b));h&&h.hint&&(this.hint=h.hint),g!==this.hint&&this.director.draw()},Visualizer.prototype.mousePressed=function(){if(this.state.options.interactive){if(this.state.replay.hasDuration&&this.state.options.decorated&&(this.counts.graph.contains(this.mouseX,this.mouseY)||this.scores.graph.contains(this.mouseX,this.mouseY)))this.mouseDown=1;else if(this.state.config.zoom!==1&&this.miniMap.contains(this.mouseX,this.mouseY))this.mouseDown=3;else if(this.shiftedMap.contains(this.mouseX,this.mouseY))this.mouseDown=2;else{this.btnMgr.mouseDown();return}this.mouseMoved(this.mouseX,this.mouseY)}else this.state.options.decorated&&this.btnMgr.mouseDown()},Visualizer.prototype.mouseReleased=function(){this.mouseDown=0,this.state.options.decorated&&this.btnMgr.mouseUp(),this.mouseMoved(this.mouseX,this.mouseY)},Visualizer.prototype.mouseExited=function(){this.state.options.decorated&&(this.btnMgr.mouseMove(-1,-1),this.btnMgr.mouseUp()),this.mouseDown=0},Visualizer.prototype.keyPressed=function(a){var b=this.director,d=!0;if(!this.state.options.embedded){d=!1;switch(a){case c.PGUP:b.gotoTick(Math.ceil(this.state.time)-10);break;case c.PGDOWN:b.gotoTick(Math.floor(this.state.time)+10);break;case c.HOME:b.gotoTick(0);break;case c.END:b.gotoTick(b.duration);break;default:d=!0}}if(d)switch(a){case c.SPACE:b.playStop();break;case c.LEFT:b.gotoTick(Math.ceil(this.state.time)-1);break;case c.RIGHT:b.gotoTick(Math.floor(this.state.time)+1);break;case c.PLUS:case c.PLUS_OPERA:case c.PLUS_JAVA:this.modifySpeed(1);break;case c.MINUS:case c.MINUS_JAVA:this.modifySpeed(-1);break;default:switch(String.fromCharCode(a)){case"F":this.setFullscreen(!this.state.config.fullscreen);break;case"C":this.centerMap();break;case"I":this.generateBotInput();break;default:return!1}}return!0},Visualizer.prototype.generateBotInput=function(){var a,b,c,d,e,f,g,h,i,j,k,l;try{if(!this.state.replay.hasDuration)return;this.director.stop(),a="",b=this.state.options.user,b&&(c=this.state.replay.meta.user_ids.indexOf(b,0),c!==-1&&(a=this.state.replay.meta.playernames[c]));do{a=prompt("Enter the player name for which you want to generate bot input.",a),h=!0;if(a){c=this.state.replay.meta.playernames.indexOf(a,0),h=c!==-1;if(h){d=1,e=this.state.replay.duration,f=1+(this.state.time|0);do{g=prompt("Enter a range of turns or a single turn number to be included in the output.\nThe largest valid range for this replay is "+d+"-"+e+".",d+"-"+f),h=!0;if(g){g=g.split("-"),h=g.length<=2;for(i=0;i<g.length;i++)h=h&&/^[0-9]+$/.test(g[i]),h=h&&!isNaN(g[i]=parseInt(g[i]));h=h&&g[0]>=d,h=h&&g[g.length-1]<=e,h?(d=g[0]-1,e=g[g.length-1]-1,j=this.state.replay.generateBotInput(c,d,e),window.saveText?(l=this.state.replay.meta.game_id||this.state.options.game||0,window.saveText(j,l+".bot"+c+".input")):(k="data:text/plain;charset=utf-8,"+escape(j),window.open(k,"_blank"))):alert("Invalid input.")}}while(!h)}else alert("Invalid user name.")}}while(!h)}catch(m){alert("Error while generating bot input: "+m)}},Options=function(){this.data_dir="",this.interactive=!0,this.decorated=!0,this.debug=!1,this.profile=!1,this.embedded=!1,this.game="",this.col=NaN,this.row=NaN,this.turn=NaN,this.user="",this.loop=!1},Options.toBool=function(a){return a=="1"||a=="true"},o.prototype.cleanUp=function(){this.scale=NaN,this.ranks=undefined,this.order=undefined,this.replay=null,this.fogPlayer=undefined,this.time=0,this.shiftX=0,this.shiftY=0,this.mouseOverVis=!1,this.mouseCol=undefined,this.mouseRow=undefined,this.isStreaming=!1,this.fade=undefined},o.prototype.getFogMap=function(){return this.replay.getFog(this.fogPlayer,this.time|0)},p.prototype.draw=function(){var a,c=this.group,d=c.manager.ctx,f=this.getLocation(),g=f.w>c.x+c.w-f.x?c.x+c.w-f.x:f.w,h=f.h>c.y+c.h-f.y?c.y+c.h-f.y:f.h;if(g<=0||h<=0)return;d.save(),d.beginPath(),d.rect(f.x,f.y,g,h),d.clip(),d.fillStyle="#fff",d.fill(),this.enabled||(d.globalAlpha=.5),a=.2*Math.min(f.w,f.h);if(this.onclick&&this.enabled){if(this.hover||this.down!==0)e.roundedRect(d,f.x,f.y,f.w,f.h,1,a),d.fillStyle="rgb(255, 230, 200)",d.fill();d.shadowBlur=4-.75*this.down,d.shadowOffsetX=-0.5*this.down,d.shadowOffsetY=.5*this.down,b.fullImageShadowSupport?d.shadowColor="rgba(0, 0, 0, 0.7)":d.shadowColor="rgba(0, 0, 0, 0)"}d.save(),d.translate(f.x,f.y-1+this.down),this.drawInternal(d),d.restore(),this.onclick&&this.enabled&&(this.hover||this.down)&&(d.shadowColor="rgba(0, 0, 0, 0)",d.lineWidth=2,d.strokeStyle="#444",d.stroke()),d.restore()},p.prototype.mouseDown=function(){var a,b;switch(this.group.mode){case q.MODE_RADIO:this.locked=!this.locked;if(this.locked){this.onclick&&this.onclick.invoke([this.idx]),b=this.group.buttons;for(a=0;a<b.length;a++)b[a].down!==0&&(b[a].down=0,b[a].locked=!1,b[a].draw())};case q.MODE_NORMAL:this.down=2}this.draw()},p.prototype.mouseUp=function(){switch(this.group.mode){case q.MODE_RADIO:this.locked?this.down=1:(this.onclick&&this.onclick.invoke([]),this.down=0);break;case q.MODE_NORMAL:this.hover&&this.onclick&&this.onclick.invoke(),this.down=0}this.draw()},q.MODE_HIDDEN=0,q.MODE_NORMAL=1,q.MODE_RADIO=2,q.prototype.draw=function(){var a;for(a=0;a<this.buttons.length;a++)this.buttons[a].draw&&this.buttons[a].draw()},q.prototype.mouseMove=function(a,b){var c;for(c=0;c<this.buttons.length;c++)if(this.buttons[c].getLocation&&this.buttons[c].getLocation().contains(a,b))return this.buttons[c].enabled?this.buttons[c]:null;return null},r.extend(p),r.prototype.drawInternal=function(a){var b=this.group.border,c=this.group.size-2*b;a.drawImage(this.group.img,this.offset,0,c,c,b,b,c,c)},r.prototype.getLocation=function(){return new h(this.group.x+(this.group.vertical?0:this.delta),this.group.y+(this.group.vertical?this.delta:0),this.group.size,this.group.size)},s.extend(q),s.HORIZONTAL=!1,s.VERTICAL=!0,s.prototype.nextDelta=function(){var a;return this.buttons.length!==0?(a=this.buttons[this.buttons.length-1],a.delta+(a.size||this.size)):0},s.prototype.addButton=function(a,b,c){var d=this.nextDelta(),e=new r(this,a,d,b,c);return this.buttons.push(e),e},s.prototype.addSpace=function(a){var b=this.nextDelta();this.buttons.push({delta:b,size:a})},s.prototype.getButton=function(a){var b;for(b=0;b<this.buttons.length;b++)if(this.buttons[b].idx===a)return this.buttons[b];return null},t.extend(p),t.prototype.drawInternal=function(a){a.textAlign="left",a.textBaseline="bottom",a.font=FONT,a.strokeStyle="#000",a.lineWidth=1,a.strokeText(this.text,4,25),a.fillStyle=this.color,a.shadowColor=this.color,a.shadowOffsetX=0,a.shadowOffsetY=0,a.shadowBlur=.5,a.fillText(this.text,4,25)},t.prototype.getLocation=function(){return new h(this.group.x+this.x,this.group.y+this.y,this.w,this.h)},t.prototype.setText=function(a){this.text=a,this.group.manager.ctx.font=FONT,this.w=this.group.manager.ctx.measureText(a).width+8},u.extend(q),u.prototype.addButton=function(a,b,c){var d=new t(this,a,b,c);return this.buttons.push(d),d},u.prototype.cascade=function(a){var b,c=null,d=0,e=0;this.w=a;for(b=0;b<this.buttons.length;b++)c=this.buttons[b],d&&d+c.w>this.w&&(d=0,e+=c.h+2),c.x=d,c.y=e,d+=c.w+2;return this.h=c?e+c.h:0},v.prototype.addImageGroup=function(a,b,c,d,e,f){return this.groups[a]=new s(this,b,c,d,e,f)},v.prototype.addTextGroup=function(a,b,c){return this.groups[a]=new u(this,b,c)},v.prototype.draw=function(){var a=undefined;for(a in this.groups)this.groups.hasOwnProperty(a)&&this.groups[a].mode!==q.MODE_HIDDEN&&this.groups[a].draw()},v.prototype.getGroup=function(a){return this.groups[a]},v.prototype.mouseMove=function(a,b){var c,d=null,e=undefined;for(e in this.groups){c=this.getGroup(e);if(c.mode!=q.MODE_HIDDEN&&b>=c.y&&b<c.y+c.h&&a>=c.x&&a<c.x+c.w){d=c.mouseMove(a,b);if(d!==null)break}}return this.hover!==d&&(this.hover&&(this.hover.hover=!1,this.hover===this.pinned?this.hover.mouseUp():this.hover.draw()),this.hover=d,d&&(this.hover.hover=!0,this.hover===this.pinned?this.hover.mouseDown():this.hover.draw())),d},v.prototype.mouseUp=function(){this.pinned&&(this.pinned.mouseUp(),this.pinned=null)},v.prototype.mouseDown=function(){this.hover&&(this.pinned=this.hover,this.pinned.mouseDown())},w.prototype.fullscreen=!1,w.prototype.label=0,w.prototype.zoom=1,w.prototype.duration=75,w.prototype.speedSlowest=2,w.prototype.speedFastest=8,w.prototype.speedFactor=0,w.prototype.cpu=.5,w.prototype.overrideFrom=function(a){var b=undefined;for(b in a){if(!w.prototype.hasOwnProperty(b)||typeof this[b]=="function")throw new Error("Cannot override '"+b+"', because it is not a known configuration value.");this[b]=a[b]}},w.prototype.hasLocalStorage=function(){try{return!!window.localStorage}catch(a){return!1}},w.prototype.save=function(){var a,b;if(this.hasLocalStorage()===!0){for(a in this)if(this[a]===undefined||this[a]===w.prototype[a])delete window.localStorage["visualizer."+a];else if(this[a]===null)window.localStorage["visualizer."+a]="null";else{b=undefined;switch(typeof this[a]){case"number":b="N";break;case"boolean":b="B";break;case"string":b="S";break;case"function":break;default:throw new Error("Only numbers, booleans and strings can be saved in the config")}b&&(window.localStorage["visualizer."+a]=b+this[a])}return!0}return!1},w.prototype.load=function(){var a,b;if(this.hasLocalStorage()===!0){for(a in this)if(typeof this[a]!="function"){b=window.localStorage["visualizer."+a];if(b==="null")this[a]=null;else if(b)switch(b.charAt(0)){case"N":this[a]=Number(b.substr(1));break;case"B":this[a]=b=="Btrue";break;case"S":this[a]=b.substr(1)}}return!0}return!1},w.prototype.clear=function(){this.hasLocalStorage()===!0&&window.localStorage.clear()},INT_TO_HEX=Array(256),function(){var a;for(a=0;a<16;a++)INT_TO_HEX[a]="0"+a.toString(16);for(;a<256;a++)INT_TO_HEX[a]=a.toString(16)}(),f=40,RIGHT_PANEL_W=48,BOTTOM_PANEL_H=64,COLOR_MAPS=[10,[1],[1,6],[1,3,6],[1,3,6,8],[0,2,4,6,8],[0,2,3,4,6,8],[0,1,3,4,5,6,8],[0,1,3,4,5,6,7,8],[0,1,2,3,4,5,6,7,8],[0,1,2,3,4,5,6,7,8,9]],PLAYER_COLORS=[[350,85,45],[20,80,55],[45,80,50],[60,90,65],[110,60,75],[155,60,45],[210,80,55],[265,80,45],[300,60,60],[345,25,75],[0,0,90]],FOOD_COLOR=j([50,20,50]),SAND_COLOR=k(j([30,35,35])),STAT_COLOR=k(j([0,0,10])),TEXT_COLOR=k(j([0,0,10])),TEXT_GRAPH_COLOR=k(j([0,0,90])),BACK_COLOR=k(j([30,30,100])),ZOOM_SCALE=20,FONT="bold 19px Arial,Sans",x.prototype.playing=function(){return this.speed!==0},x.prototype.playStop=function(){this.playing()?this.stop():this.play()},x.prototype.play=function(){this.playing()||(this.speed=this.defaultSpeed,this.vis.state.options.loop?this.stopAt=undefined:(this.time===this.duration&&(this.vis.state.time=this.time=0),this.stopAt=this.duration),this.onstate&&this.onstate(),this.loop(0),this.vis.state.options.profile&&console.profile())},x.prototype.stop=function(){this.playing()&&(this.vis.state.options.profile&&console.profileEnd(),this.speed=0,this.lastTime=undefined,this.onstate&&this.onstate())},x.prototype.gotoTick=function(a){var b;this.stop(),b=Math.clamp(a,0,this.duration),this.vis.state.fade=undefined,this.vis.state.time!==b&&(this.vis.state.time=this.time=b,this.vis.draw())},x.prototype.slowmoTo=function(a){var b,c=Math.clamp(a,0,this.duration);this.vis.state.time!==c&&(this.stopAt=c,b=this.playing(),this.vis.state.time<c?this.speed=1:this.speed=-1,b||(this.onstate&&this.onstate(),this.loop(0)))},x.prototype.loop=function(a){var b,c,d,e,f,g,h,i,j,k,l=undefined,m=this.lastTime;if(this.speed===0)return;if(this.fixedFpt===undefined){this.lastTime=(new Date).getTime();if(m!==undefined){l=this.lastTime-m-a;do d=(this.lastTime-m)*this.speed*.001,c=undefined,e=!1,this.vis.state.options.loop&&d!==0&&(this.speed>0?this.time<0?(c=0-this.time,c<=d&&(this.time+=c,this.speed=this.defaultSpeed,e=!0)):this.time<this.duration?(c=this.duration-this.time,c<=d&&(this.time+=c,this.speed=1,e=!0)):(c=this.duration+1.5-this.time,c<=d&&(this.time=-1.5,e=!0)):this.time>this.duration?(c=this.duration-this.time,c>=d&&(this.time+=c,this.speed=this.defaultSpeed,e=!0)):this.time>0?(c=0-this.time,c>=d&&(this.time+=c,this.speed=-1,e=!0)):(c=-1.5-this.time,c>=d&&(this.time=this.duration+1.5,e=!0))),e?m+=(this.lastTime-m)*(c/d):this.time+=d;while(e)}}else this.frameCounter++,this.time=this.frameCounter/this.fixedFpt;g=!0,this.speed<0?this.time<=this.stopAt&&(this.time=this.stopAt,g=!1,this.stop()):this.speed>0&&this.time>=this.stopAt&&(this.time=this.stopAt,g=!1,this.stop()),this.vis.state.options.loop&&(this.time<0||this.time>this.duration)?(this.time<-1?(c=Math.round(255*(2+this.time)),d=1):this.time<0?(c=255,d=-this.time):this.time>this.duration+1?(c=Math.round(255*(this.time-this.duration-1)),d=1):(c=0,d=this.time-this.duration),this.vis.state.fade="rgba("+c+","+c+","+c+","+d+")"):this.vis.state.fade=undefined,this.vis.state.time=Math.clamp(this.time,0,this.duration),this.vis.draw(),g&&(this.fixedFpt===undefined?(this.vis.state.options.debug&&l!==undefined&&(this.frameStart===undefined&&(this.frameStart=m,this.frameCounter=0,this.frameCpu=0),this.frameCounter++,this.frameCpu+=l,this.lastTime>=this.frameStart+1e3&&(h=this.lastTime-this.frameStart,i=Math.round(1e3*this.frameCounter/h),j=Math.round(100*this.frameCpu/h),document.title=i+" fps @ "+j+"% cpu",this.frameStart=this.lastTime,this.frameCounter=0,this.frameCpu=0)),f=this.cpu<=0||this.cpu>1||l===undefined):f=!0,k=this,f?k.timeout=window.setTimeout(function(){k.loop(a)},0):(b=f?0:Math.ceil(l/this.cpu-l),this.timeout=window.setTimeout(function(){k.timeout=window.setTimeout(function(){k.loop(b)},b)},0)))},x.prototype.cleanUp=function(){window.clearTimeout(this.timeout),this.stop()},x.prototype.draw=function(a){this.playing()?a&&(window.clearTimeout(this.timeout),this.loop(0)):this.vis.draw()},x.prototype.speedUp=function(){this.defaultSpeed*=1.5,this.speed*=1.5},x.prototype.slowDown=function(){this.defaultSpeed/=1.5,this.speed/=1.5},z.prototype.add=function(a){this.info.push(new y(this.dataDir+a)),this.images.push(null),this.patterns.push(null)},z.prototype.cleanUp=function(){var a;for(a=0;a<this.images.length;a++)this.info[a].success===!1&&(this.info[a].success=undefined,this.images[a]=null,this.pending++);this.startRequests()},z.prototype.startRequests=function(){var a,b,c;this.error="";for(b=0;b<this.images.length;b++)this.info[b].success===undefined&&!this.images[b]&&(a=new Image,this.images[b]=a,c=this,a.onload=function(){c.imgHandler(this,!0)},a.onerror=function(){c.imgHandler(this,!1)},a.onabort=a.onerror,a.src=this.info[b].src,this.pending++)},z.prototype.imgHandler=function(a,b){var c;for(c=0;c<this.images.length;c++)if(this.images[c].src===a.src)break;b||(this.error&&(this.error+="\n"),this.error+=this.info[c].src+" did not load."),this.info[c].success=b,--this.pending==0&&this.callback.invoke([this.error])},z.prototype.pattern=function(a,b,c){this.patterns[a]||(this.patterns[a]=b.createPattern(this.images[a],c)),b.fillStyle=this.patterns[a]},z.prototype.colorize=function(a,b){var c,d,e,f,g,h,i,j,k,l,m=document.createElement("canvas"),n=m.getContext("2d");this.patterns[a]=m,m.width=this.images[a].width*b.length,m.height=this.images[a].height,n.fillStyle=n.createPattern(this.images[a],"repeat"),n.fillRect(0,0,m.width,m.height);if(!this.restrictSecurity){try{j=n.getImageData(0,0,m.width,m.height)}catch(o){try{l=netscape.security.PrivilegeManager,this.askSecurity&&(this.askSecurity=!1),l.enablePrivilege("UniversalBrowserRead"),j=n.getImageData(0,0,m.width,m.height)}catch(p){this.restrictSecurity=!0;return}}c=j.data,d=0,e=4*this.images[a].width;for(g=0;g<b.length;g++){f=b[g];if(f){typeof f=="string"&&(f=[15*parseInt(f.charAt(1),16),15*parseInt(f.charAt(2),16),15*parseInt(f.charAt(3),16)]);for(h=0;h<4*j.width*j.height;h+=4*j.width)for(i=h+d;i<h+d+e;i+=4)k=c[i],k===c[i+1]&&k===c[i+2]&&(k<128?(c[i+0]=c[i+0]*f[0]>>7,c[i+1]=c[i+1]*f[1]>>7,c[i+2]=c[i+2]*f[2]>>7):(k=k/127.5-1,c[i+0]=(1-k)*f[0]+k*255,c[i+1]=(1-k)*f[1]+k*255,c[i+2]=(1-k)*f[2]+k*255))}d+=e}n.putImageData(j,0,0)}},A.N=new A(0,-1),A.E=new A(1,0),A.S=new A(0,1),A.W=new A(-1,0),DataType={STRING:function(a){return[a,null]},IDENT:function(a){return a=a.match(DataType.MATCH),[a[1],a[2]]},UINT:function(a,b){a=a.match(DataType.MATCH),a=[parseInt(a[1]),a[2]];if(isNaN(a[0])||a[0]<0)throw new Error("Parameter "+b+" must be an unsigned integer.");return a},POSINT:function(a,b){a=DataType.UINT(a,b);if(a[0]>0)return a;throw new Error("Parameter "+b+" must be a positive integer.")},NUMBER:function(a,b){a=a.match(DataType.MATCH),a=[parseFloat(a[1]),a[2]];if(isNaN(a[0]))throw new Error("Parameter "+b+" is not a number.");return a},ORDERS:function(a){var b;a=a.match(DataType.MATCH),a[1]=a[1].split(""),a[0]=Array(a[1].length);for(b=0;b<a[1].length;b++)switch(a[1][b]){case"n":case"N":a[0][b]=A.N;break;case"e":case"E":a[0][b]=A.E;break;case"s":case"S":a[0][b]=A.S;break;case"w":case"W":a[0][b]=A.W;break;case"-":a[0][b]=null;break;default:throw new Error("Invalid character in orders line: "+a[1][b])}return[a[0],a[2]]},SCORES:function(a){var b;a=a.replace(/\s+/g," ").replace(/\s*$/,"").split(" ");for(b=0;b<a.length;b++){a[b]=parseFloat(a[b]);if(isNaN(a[b]))throw new Error("Score "+b+" is not a number.")}return[a,null]},MATCH:/(\S*)\s*(.*)/},B.prototype.addMissingMetaData=function(a){var b,c,d,e,f,g,h;this.meta.playernames instanceof Array||(this.meta.players instanceof Array?(this.meta.playernames=this.meta.players,delete this.meta.players):this.meta.playernames=Array(this.players)),this.meta.playercolors instanceof Array||(this.meta.playercolors=Array(this.players)),this.meta.playerturns instanceof Array||(this.meta.playerturns=Array(this.players)),this.meta.challenge_rank&&(c=this.meta.challenge_rank.slice()),a!==undefined?(e=COLOR_MAPS[this.players-1],c.splice(a,1)):e=COLOR_MAPS[this.players],c&&(d=c.slice().sort(function(a,b){return a-b})),f=0;for(b=0;b<this.players;b++)this.meta.playernames[b]||(this.meta.playernames[b]="player "+(b+1)),this.meta.replaydata.scores&&!this.meta.playerturns[b]&&(this.meta.playerturns[b]=this.meta.replaydata.scores[b].length-1),this.meta.playercolors[b]instanceof Array||(a!==undefined&&b===a?(g=PLAYER_COLORS[COLOR_MAPS[0]],f=1):c?(h=d.indexOf(c[b-f]),g=PLAYER_COLORS[e[h]],d[h]=null):g=PLAYER_COLORS[e[b]],this.meta.playercolors[b]=g=j(g));this.htmlPlayerColors=Array(this.players);for(b=0;b<this.players;b++)this.htmlPlayerColors[b]="#",this.htmlPlayerColors[b]+=INT_TO_HEX[this.meta.playercolors[b][0]],this.htmlPlayerColors[b]+=INT_TO_HEX[this.meta.playercolors[b][1]],this.htmlPlayerColors[b]+=INT_TO_HEX[this.meta.playercolors[b][2]]},B.prototype.txtToJson=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s=new C(a),t={revision:3,map:{data:[]},hills:[],ants:[],food:[],scores:[],hive_history:[]};this.turns=[],d=s.gimmeNext();try{q=d.keyword==="v",q&&(d.kw("v").as([DataType.IDENT,DataType.POSINT]),d.expectEq(0,"ants"),d.expectEq(1,1),d=s.gimmeNext(),d.kw("players").as([DataType.POSINT]),d.expectLE(0,26),t.players=d.params[0],d=s.gimmeNext());while(d.keyword!=="m"){e=[DataType.STRING];if(d.keyword==="viewradius2"||d.keyword==="rows"||d.keyword==="cols"||d.keyword==="players"||d.keyword==="turns")e[0]=DataType.UINT;d.as(e),d.keyword==="rows"||d.keyword==="cols"?t.map[d.keyword]=d.params[0]:t[d.keyword]=d.params[0],d=s.gimmeNext()}g=undefined,f=0;do{d.as([DataType.STRING]);if(g===undefined)g=d.params[0].length;else if(d.params[0].length!==g&&!this.debug)throw new Error("Map lines have different lenghts");t.map.data.push(d.params[0]);if(!q)for(j=0;j<g;j++)c=d.params[0].charAt(j),c<"a"||c>"z"?c<"A"||c>"Z"?c<"0"||c>"9"?c==="*"&&t.food.push([f,j,0]):(c=c.charCodeAt(0)-48,t.hills.push([f,j,c,1])):(c=c.charCodeAt(0)-65,t.ants.push([f,j,0,1,c,"-"]),t.hills.push([f,j,c,1])):(c=c.charCodeAt(0)-97,t.ants.push([f,j,0,1,c,"-"]));f++;if(q||s.moar())d=s.gimmeNext();else break}while(d.keyword==="m");if(q){while(d.keyword==="a"){d.as([DataType.UINT,DataType.UINT,DataType.UINT,DataType.UINT,DataType.UINT,DataType.UINT,DataType.STRING],3),i=d.params[0];if(i>=this.rows)throw new Error("Row exceeds map width.");j=d.params[1];if(j>=this.cols)throw new Error("Col exceeds map height.");l=d.params[3],m=d.params[4],m===undefined&&(m=l),h=d.params[5],k=h!==undefined;if(k&&h>=this.players)throw new Error("Player index out of range.");d.params.length===6&&d.params.push(""),n=d.params[6];if(k){o=n.length!==m-l;if(o&&n.length+1!==m-l)throw new Error("Number of orders does not match life span.")}t.ants.push(d.params),d=s.gimmeNext()}r=this.players||t.players;for(b=0;b<r;b++)p=d.kw("s").as([DataType.SCORES]).params[0],t.scores.push(p),b!=r-1&&(d=s.gimmeNext())}else for(b=0;b<t.players;b++)t.scores.push([0]),t.hive_history.push([0]);if(s.moar())throw d=s.gimmeNext(),new Error("Extra data at end of file.")}catch(u){throw u.message=d.line+"\n"+u.message,u}return t},B.prototype.getTurn=function(a){var b,c,d,e,f,g,h,i,j,k,l,m;if(this.turns[a]===undefined){a!==0&&this.getTurn(a-1),d=this.turns[a]=[],e=this.meta.replaydata.ants,j=this.meta.replaydata.food;for(b=0;b<e.length;b++){f=e[b];if(f[2]===a+1||a===0&&f[2]===0)this.revision<3?g=this.spawnFood(b,f[0],f[1],f[2],f[5]):g=this.spawnAnt(b,f[0],f[1],f[2],f[4]);else if(this.aniAnts[b])g=this.aniAnts[b];else continue;this.revision<3?(f[5]!==undefined&&(f[3]===a+1||a===0&&f[3]===0)&&this.convertAnt(g,f[3]==f[2],f[3],f[5]),k=f[6],l=f[3]):(k=f[5],l=f[2]);if(k!==undefined&&a>=l&&a<l+k.length){this.revision<=2&&(g.frameAt(a).owner=f[5]),m=undefined;switch(k.charAt(a-l)){case"n":case"N":m=A.N;break;case"e":case"E":m=A.E;break;case"s":case"S":m=A.S;break;case"w":case"W":m=A.W}m&&(h=g.keyFrames[g.keyFrames.length-1],g.fade("x",h.x+m.x,a,a+.5),g.fade("y",h.y+m.y,a,a+.5))}this.revision<3?i=f[4]||l:i=f[3]||l,i===a+1&&this.killAnt(g,i),a<i&&d.push(g)}if(this.revision>=3)for(b=0;b<j.length;b++){f=j[b],c=b+e.length;if(f[2]===a+1||a===0&&f[2]===0)g=this.spawnFood(c,f[0],f[1],f[2],undefined);else if(this.aniAnts[c])g=this.aniAnts[c];else continue;i=f[3],i===a+1&&this.killAnt(g,i),(i===undefined||a<i)&&d.push(g)}}return this.turns[a]},B.prototype.spawnFood=function(a,b,c,d,e){var f=this.aniAnts[a]=new l(a,d-.25),g=f.frameAt(d-.25);return f.owner=e,g.x=c,g.y=b,g.r=FOOD_COLOR[0],g.g=FOOD_COLOR[1],g.b=FOOD_COLOR[2],d!==0&&(g=f.frameAt(d),g.size=1,g=f.frameAt(d+.125),g.size=1.5,g=f.frameAt(d+.25),g.size=.7,g=f.frameAt(d+.5)),g.size=1,f},B.prototype.spawnAnt=function(a,b,c,d,e){var f=this.aniAnts[a]=new l(a,d-.25),g=this.meta.playercolors[e],h=f.frameAt(d-.25);return f.owner=e,h.x=c,h.y=b,h.owner=e,h.r=g[0],h.g=g[1],h.b=g[2],d!==0&&(h=f.frameAt(d),h.size=1,h=f.frameAt(d+.125),h.size=1.5,h=f.frameAt(d+.25),h.size=.7,h=f.frameAt(d+.5)),h.size=1,f},B.prototype.convertAnt=function(a,b,c,d){var e=this.meta.playercolors[d];b||(a.fade("r",255,c-.5,c-.25),a.fade("g",255,c-.5,c-.25),a.fade("b",255,c-.5,c-.25)),a.frameAt(c-.25).owner=d,a.fade("r",e[0],c-.25,c),a.fade("g",e[1],c-.25,c),a.fade("b",e[2],c-.25,c)},B.prototype.killAnt=function(a,b){var c,d=a.frameAt(b).owner;d===undefined?c=FOOD_COLOR:c=this.meta.playercolors[d],a.fade("r",255,b-.8,b-.6),a.fade("g",255,b-.8,b-.6),a.fade("b",255,b-.8,b-.6),a.fade("r",c[0],b-.6,b-.4),a.fade("g",c[1],b-.6,b-.4),a.fade("b",c[2],b-.6,b-.4),a.fade("r",0,b-.4,b),a.fade("g",0,b-.4,b),a.fade("b",0,b-.4,b),a.fade("size",.7,b-.8,b-.6),a.fade("size",0,b-.4,b),a.death=b},B.prototype.deadAnt=function(a,b){var c=a.frameAt(b),d=c.owner,e=this.meta.playercolors[d],f=e[0]>>1,g=e[1]>>1,h=e[2]>>1;c.r=f,c.g=g,c.b=h,c.size=.7},B.prototype.getFog=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p=this.fogs[a];if(p[b]===undefined){p[b]=d=Array(this.rows);for(e=0;e<this.rows;e++){d[e]=Array(this.cols);for(f=0;f<this.cols;f++)d[e][f]=!0}h=this.meta.replaydata.viewradius2,g=Math.sqrt(h)|0,i=Array(2*g+1),j=Array(2*g+1),n=this.getTurn(b);for(c=0;c<n.length;c++){o=n[c].interpolate(b);if(o&&o.owner===a){for(e=2*g;e>=0;e--)i[e]=Math.wrapAround(o.y-g+e,this.rows);for(f=2*g;f>=0;f--)j[f]=Math.wrapAround(o.x-g+f,this.cols);f=j[g];for(e=1;e<=g;e++)d[i[g-e]][f]=!1,d[i[g+e]][f]=!1;k=d[i[g]];for(f=0;f<j.length;f++)k[j[f]]=!1;for(e=1;e<=g;e++){l=d[i[g-e]],m=d[i[g+e]];for(f=1;f<=g;f++)e*e+f*f<=h&&(l[j[g-f]]=!1,l[j[g+f]]=!1,m[j[g-f]]=!1,m[j[g+f]]=!1)}}}}return p[b]},B.prototype.generateBotInput=function(a,b,c){var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,B=undefined,C=0,D=Array(this.players),E=function(a){return D[a]===undefined&&(D[a]=C,C++),D[a]};E(a),x="turn 0\n",y=function(a,c,d,e,f){a>=b&&(c[c.length]=[d,e,f]),f!==undefined&&E(f)},z=function(a,b){var c,d;b.sort(function(a,b){return a[0]!==b[0]?a[0]-b[0]:a[1]!==b[1]?a[1]-b[1]:a[2]-b[2]});for(c=0;c<b.length;c++)d=b[c],x+=a+" "+d[0]+" "+d[1],d[2]!==undefined&&(x+=" "+E(d[2])),x+="\n"};if(this.meta.replaydata.revision!==3)throw new Error("Can only generate bot input for revision 3 replays!");x+="rows "+this.rows+"\n",x+="cols "+this.cols+"\n";for(B in this.meta.replaydata){if(B==="revision")continue;if(B==="food_rate")continue;if(B==="food_turn")continue;if(B==="food_start")continue;if(B==="engine_seed")continue;if(B==="winning_turn")continue;if(B==="ranking_turn")continue;e=this.meta.replaydata[B],typeof e=="number"&&!isNaN(e)&&isFinite(e)&&(x+=B+" "+e+"\n")}x+="ready\n",g=Array(this.rows);for(j=0;j<g.length;j++)g[j]=Array(this.cols);l=this.meta.replaydata.ants,v=Array(l.length);for(i=0;i<v.length;i++){v[i]=Array(c+1),u=l[i],j=u[0],k=u[1],v[i][u[2]]=[j,k],p=new String(u[5]);for(d=0;d<p.length;){o=undefined;switch(p.charAt(d)){case"n":case"N":o=A.N;break;case"e":case"E":o=A.E;break;case"s":case"S":o=A.S;break;case"w":case"W":o=A.W}o&&(j=Math.wrapAround(j+o.y,this.rows),k=Math.wrapAround(k+o.x,this.cols)),d++,v[i][u[2]+d]=[j,k]}}f=0;for(d=0;d<=c;d++){h=this.getFog(a,d),q=[],r=[],s=[],t=[],n=this.meta.replaydata.hills;for(i=0;i<n.length;i++)d<n[i][3]&&!h[n[i][0]][n[i][1]]&&y(d,q,n[i][0],n[i][1],n[i][2]);for(i=0;i<l.length;i++)w=v[i][d],l[i][2]<=d&&(d<l[i][3]?h[w[0]][w[1]]||y(d,r,w[0],w[1],l[i][4]):d===l[i][3]&&(l[i][4]===a||!h[w[0]][w[1]])&&y(d,t,w[0],w[1],l[i][4]));if(d>=b){f++,x+="turn "+f+"\n";for(j=0;j<this.rows;j++)for(k=0;k<this.cols;k++)h[j][k]||g[j][k]===undefined&&(g[j][k]=this.walls[j][k])&&(x+="w "+j+" "+k+"\n");z("h",q),z("a",r),m=this.meta.replaydata.food;for(i=0;i<m.length;i++)m[i][2]<=d&&d<m[i][3]&&!h[m[i][0]][m[i][1]]&&y(d,s,m[i][0],m[i][1]);z("f",s),z("d",t),x+="go\n"}}return x},C.NORMALIZE_REGEXP=/^([^\S\n]*(#.*)?\n)*|(\n[^\S\n]*(#.*)?)*$|\n[^\S\n]*(#.*)?(?=\n)/g,C.prototype.gimmeNext=function(){if(this.pos<this.tokenLines.length)return this.tokenLines[this.pos++];throw new Error("Tried to read past the end of the file. Is it truncated?")},C.prototype.moar=function(){return this.pos<this.tokenLines.length},D.KEYWORD_REGEXP=/(\S+)\s*(.*)/,D.prototype.kw=function(a){return this.keyword!==a&&this.expected(a,this.keyword),this},D.prototype.as=function(a,b){var c,d,e;b===undefined&&(b=0),c=this.params,this.params=[];for(d=0;d<a.length;d++)if(c||a.length-d>b)e=a[d](c),this.params.push(e[0]),c=e[1];if(c)throw new Error("The following unexpected additional parameter was found: "+c);return this},D.prototype.expected=function(a,b){throw new Error("Expected "+a+", but "+b+" found.")},D.prototype.expectEq=function(a,b){b!==this.params[a]&&this.expected(b,this.params[a])},D.prototype.expectLE=function(a,b){b<this.params[a]&&this.expected("parameter "+a+" to be <= "+b,this.params[a])},E.prototype.setSize=function(a,b){if(this.w!==a||this.h!==b)this.w=a,this.h=b,a>0&&b>0&&(this.canvas.width=a,this.canvas.height=b),this.invalid=!0,this.resized=!0},E.prototype.contains=function(a,b){return a>=this.x&&a<this.x+this.w&&b>=this.y&&b<this.y+this.h},E.prototype.validate=function(){var a;for(a=0;a<this.dependencies.length;a++)this.dependencies[a].validate()&&(this.invalid=!0);return this.checkState(),this.invalid?(this.draw(this.resized),this.invalid=!1,this.resized=!1,!0):!1},E.prototype.checkState=function(){},E.prototype.dependsOn=function(
a){this.dependencies.push(a),a.invalidates.push(this)},E.prototype.drawWrapped=function(a,b,c,d,e,f,g,h){var i,j,k,l,m;if(a<0||b<0||a+c>e||b+d>f){this.ctx.save(),i=-Math.floor((a+c)/e)*e,j=-Math.floor((b+d)/f)*f,this.ctx.translate(i,j);for(l=b+j;l<f;l+=f){m=0;for(k=a+i;k<e;k+=e)g.apply(this,h),this.ctx.translate(e,0),m-=e;this.ctx.translate(m,f)}this.ctx.restore()}else g.apply(this,h)},F.extend(E),F.prototype.redFocusRectFun=function(a,b){var c,d,e,f;for(f=0;f<5;f++)this.ctx.strokeStyle="rgba(255,0,0,"+(f+1)/5+")",e=this.scale+9-2*f,c=a+f,d=b+f,this.ctx.strokeRect(c,d,e,e)},F.prototype.draw=function(){var a,b,c,d,e,f,g=this.state.replay.rows,h=this.state.replay.cols,i=this.state.options.row,j=this.state.options.col;this.ctx.fillStyle=SAND_COLOR,this.ctx.fillRect(0,0,this.w,this.h),this.ctx.fillStyle=this.ctx.createPattern(this.water,"repeat");for(a=0;a<g;a++){c=undefined;for(b=0;b<h;b++)d=this.state.replay.walls[a][b],c===undefined&&d?c=b:c!==undefined&&!d&&(this.ctx.fillRect(this.scale*c,this.scale*a,this.scale*(b-c),this.scale),c=undefined);c!==undefined&&this.ctx.fillRect(this.scale*c,this.scale*a,this.scale*(b-c),this.scale)}!isNaN(i)&&!isNaN(j)&&(e=j%h*this.scale-4.5,f=i%g*this.scale-4.5,this.drawWrapped(e,f,this.scale+9,this.scale+9,this.w,this.h,this.redFocusRectFun,[e,f]))},G.extend(F),G.prototype.checkState=function(){(this.state.time|0)!==this.turn&&(this.invalid=!0,this.turn=this.state.time|0,this.ants=this.state.replay.getTurn(this.turn))},G.prototype.draw=function(){var a,b,c,d,e,f,g;F.prototype.draw.call(this);for(a=this.ants.length-1;a>=0;a--)if(b=this.ants[a].interpolate(this.turn))c="#",c+=INT_TO_HEX[b.r],c+=INT_TO_HEX[b.g],c+=INT_TO_HEX[b.b],this.ctx.fillStyle=c,this.ctx.fillRect(b.x,b.y,1,1);d=this.state.replay.meta.replaydata.hills;for(a=0;a<d.length;a++)e=d[a],f=e[1]+.5,g=e[0]+.5,this.turn<e[3]&&(this.ctx.fillStyle=this.state.replay.htmlPlayerColors[e[2]],this.ctx.beginPath(),this.ctx.arc(f,g,1.4,0,2*Math.PI,!1),this.ctx.fill())},H.extend(F),H.prototype.checkState=function(){this.scale!==this.state.scale&&(this.invalid=!0,this.scale=this.state.scale)},I.extend(E),I.prototype.checkState=function(){this.player!==this.state.fogPlayer&&(this.invalid=!0,this.player=this.state.fogPlayer)},I.prototype.draw=function(){this.player!==undefined&&(this.ctx.fillStyle=this.state.replay.htmlPlayerColors[this.player],this.ctx.fillRect(0,0,1,1),this.ctx.fillRect(1,1,1,1))},J.extend(E),J.prototype.checkState=function(){if(this.player!==this.state.fogPlayer||this.player!==undefined&&(this.state.shiftX!==this.shiftX&&this.w<this.scale*this.state.replay.cols||this.state.shiftY!==this.shiftY&&this.h<this.scale*this.state.replay.rows||this.turn!==(this.state.time|0)||this.scale!==this.state.scale))this.invalid=!0,this.shiftX=this.state.shiftX,this.shiftY=this.state.shiftY,this.scale=this.state.scale,this.turn=this.state.time|0,this.player!==this.state.fogPlayer&&(this.player=this.state.fogPlayer,this.player!==undefined&&(this.ptrn=this.ctx.createPattern(this.pattern.canvas,"repeat"),this.ctx.clearRect(0,0,this.w,this.h))),this.player===undefined?this.fogMap=null:this.fogMap=this.state.getFogMap()},J.prototype.draw=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n=null;if(this.fogMap){this.ctx.fillStyle=this.ptrn,this.ctx.fillRect(0,0,this.w,this.h),h=this.fogMap[0].length,d=this.scale*h,a=this.w<d?(this.w-d>>1)+this.shiftX:0,g=this.fogMap.length,c=this.scale*g,b=this.h<c?(this.h-c>>1)+this.shiftY:0,e=Math.floor(-a/this.scale),f=Math.floor(-b/this.scale),j=Math.wrapAround(f,g);for(l=b+f*this.scale;l<this.h;l+=this.scale){m=this.fogMap[j],i=Math.wrapAround(e,h);for(k=a+e*this.scale;k<this.w;k+=this.scale)m[i]===!1?n===null&&(n=k):n!==null&&(this.ctx.clearRect(n,l,k-n,this.scale),n=null),i=(i+1)%h;n!==null&&(this.ctx.clearRect(n,l,k-n,this.scale),n=null),j=(j+1)%g}}else this.ctx.clearRect(0,0,this.w,this.h)},K.extend(E),K.prototype.checkState=function(){var a,b,c,d,e,f,g,h,i,j,k,l=undefined,m=this.time!==this.state.time;if(m||this.scale!==this.state.scale||this.label!==this.state.config.label){this.invalid=!0,this.time=this.state.time,this.scale=this.state.scale,this.label=this.state.config.label;if(this.turn!==(this.time|0)){i=this.state.replay.cols,h=this.state.replay.rows,this.turn=this.time|0,this.ants=this.state.replay.getTurn(this.turn),this.pairing=Array(this.ants.length);for(a=this.ants.length-1;a>=0;a--)if(c=this.ants[a].interpolate(this.turn))k=c.owner,c=this.ants[a].interpolate(this.turn+1),this.pairing[this.ants[a].id]={kf:c,owner:k,x:Math.wrapAround(c.x,i),y:Math.wrapAround(c.y,h),targets:[]};if(j=this.state.replay.meta.replaydata.attackradius2)for(a=this.ants.length-1;a>=0;a--)if(this.ants[a].death===this.turn+1){d=this.pairing[this.ants[a].id];if(d!==undefined&&d.owner!==undefined)for(b=this.ants.length-1;b>=0;b--)if(this.ants[b].death!==this.turn+1||b<a)e=this.pairing[this.ants[b].id],e!==undefined&&e.owner!==undefined&&d.owner!==e.owner&&(f=Math.wrapAround(e.x-d.x,i),2*f>i&&(f-=i),g=Math.wrapAround(e.y-d.y,h),2*g>h&&(g-=h),f*f+g*g<=j&&(d.targets.push(e.kf),e.targets.push(d.kf)))}}this.drawStates=new Object;for(a=this.ants.length-1;a>=0;a--)if(c=this.ants[a].interpolate(this.time))l="#",l+=INT_TO_HEX[c.r],l+=INT_TO_HEX[c.g],l+=INT_TO_HEX[c.b],c.calcMapCoords(this.scale,this.w,this.h),this.drawStates[l]||(this.drawStates[l]=[]),this.drawStates[l].push(c)}if(this.mouseOverVis!==this.state.mouseOverVis||this.mouseOverVis&&(m||this.mouseCol!==this.state.mouseCol||this.mouseRow!==this.state.mouseRow))this.mouseOverVis=this.state.mouseOverVis,this.mouseCol=this.state.mouseCol,this.mouseRow=this.state.mouseRow,this.collectAntsAroundCursor()&&(this.invalid=!0)},K.prototype.collectAntsAroundCursor=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n=[],o=undefined,p=!0;if(this.mouseOverVis){a=this.scale*this.mouseCol,b=this.scale*this.mouseRow,c=this.state.replay.meta.replaydata.attackradius2,c*=this.scale*this.scale,d=this.state.replay.meta.replaydata.spawnradius2,d*=this.scale*this.scale,e=this.scale*this.state.replay.cols,f=this.scale*this.state.replay.rows;for(o in this.drawStates){g=this.drawStates[o];for(h=g.length-1;h>=0;h--){j=g[h],k=Math.dist_2(a,b,j.mapX,j.mapY,e,f),l=j.owner!==undefined;if(!l&&k<=d||l&&k<=c){if(p){m=!1;for(i=0;i<this.circledAnts.length;i++)if(this.circledAnts[i]===j){m=!0;break}p&=m}n.push(j)}}}}return p&=n.length===this.circledAnts.length,p?!1:(this.circledAnts=n,!0)},K.prototype.draw=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C=undefined;this.ctx.drawImage(this.map.canvas,0,0),a=.5*this.scale,A=this.state.replay.meta.replaydata.hills;for(B=0;B<A.length;B++){z=A[B],q=(z[1]-1)*this.scale,r=(z[0]-1)*this.scale,s=(z[1]+.5)*this.scale,t=(z[0]+.5)*this.scale,e=3*this.scale,f=60*z[2];if(this.turn<z[3]){this.ctx.strokeStyle=this.state.replay.htmlPlayerColors[z[2]],this.ctx.fillStyle=this.state.replay.htmlPlayerColors[z[2]],this.scale<5&&this.drawWrapped(s-3*this.scale,t-3*this.scale,6*this.scale,6*this.scale,this.w,this.h,function(){var a,b=Math.max(4*this.scale,8);this.ctx.lineWidth=1,this.ctx.globalAlpha=.5;for(a=0;a<2*b;a+=2)this.ctx.beginPath(),this.ctx.arc(s,t,3*this.scale,(a-.3)*Math.PI/b,(a+.3)*Math.PI/b,!1),this.ctx.stroke()},[]),m=z[3]<=this.state.replay.duration;if(m&&this.turn>=z[3]-30||this.turn<=10){y=this.scale*Math.max(3,z[3]-this.time-17),x=this.scale*(3+this.time),w=99;D:for(C in this.drawStates){b=this.drawStates[C];for(c=b.length-1;c>=0;c--){d=b[c];if(d.owner!==undefined&&d.owner!==z[2]){h=Math.dist_2(this.scale*z[1],this.scale*z[0],d.mapX,d.mapY,this.w,this.h);if(w*w>=h){w=Math.sqrt(h);if(w<3*this.scale){w=3*this.scale;break D}}}}}y=Math.min(Math.max(y,w),x)-this.scale,this.drawWrapped(s-y-a,t-y-a,2*y+this.scale,2*y+this.scale,this.w,this.h,function(){var b=y/a;b<25&&this.state.replay.hasDuration&&(this.ctx.lineWidth=2*a,this.ctx.globalAlpha=Math.max(0,1-.04*b),this.ctx.beginPath(),this.ctx.arc(s,t,y,0,2*Math.PI,!1),this.ctx.stroke(),this.ctx.globalAlpha=Math.max(0,.5-.02*b),this.ctx.beginPath(),this.ctx.arc(s,t,y-this.scale,0,2*Math.PI,!1),this.ctx.stroke())},[])}this.ctx.globalAlpha=1,this.drawWrapped(q,r,3*this.scale,3*this.scale,this.w,this.h,function(){this.ctx.drawImage(this.hillImage,f,0,60,60,q,r,e,e)},[])}else this.drawWrapped(q,r,3*this.scale,3*this.scale,this.w,this.h,function(){this.ctx.drawImage(this.hillImage,f,60,60,60,q,r,e,e)},[])}for(C in this.drawStates){this.ctx.fillStyle=C,b=this.drawStates[C];for(c=b.length-1;c>=0;c--)d=b[c],d.owner!==undefined?this.drawWrapped(d.mapX,d.mapY,this.scale,this.scale,this.w,this.h,function(a,b,c){this.ctx.beginPath(),this.ctx.arc(a,b,c,0,2*Math.PI,!1),this.ctx.fill()},[d.mapX+a,d.mapY+a,a*d.size]):(e=this.scale,f=d.mapX,g=d.mapY,d.size!==1&&(h=.5*(1-d.size)*this.scale,f+=h,g+=h,e*=d.size),this.ctx.fillRect(f,g,e,e))}o=this.state.replay.rows,u=o*this.scale,p=this.state.replay.cols,v=p*this.scale,this.ctx.lineWidth=Math.pow(this.scale,.3);for(C in this.drawStates){b=this.drawStates[C],this.ctx.strokeStyle=C,this.ctx.beginPath();for(c=b.length-1;c>=0;c--){d=b[c];if(this.pairing[d.antId]!==undefined)for(h=this.pairing[d.antId].targets.length-1;h>=0;h--)n=this.pairing[d.antId].targets[h],q=d.mapX+a,r=d.mapY+a,f=Math.wrapAround(n.mapX-d.mapX,v),2*f>v&&(f-=v),s=q+.5*f,g=Math.wrapAround(n.mapY-d.mapY,u),2*g>u&&(g-=u),t=r+.5*g,this.drawWrapped(Math.min(q,s)-1,Math.min(r,t)-1,Math.abs(s-q)+2,Math.abs(t-r)+2,v,u,function(a,b,c,d){this.ctx.moveTo(a,b),this.ctx.lineTo(c,d)},[q,r,s,t])}this.ctx.stroke()}if(this.mouseOverVis){w=this.state.replay.meta.replaydata.attackradius2,w=this.scale*Math.sqrt(w),x=this.state.replay.meta.replaydata.spawnradius2,x=this.scale*Math.sqrt(x);for(c=this.circledAnts.length-1;c>=0;--c)d=this.circledAnts[c],C="#",C+=INT_TO_HEX[d.r],C+=INT_TO_HEX[d.g],C+=INT_TO_HEX[d.b],this.ctx.strokeStyle=C,this.ctx.beginPath(),f=d.mapX+a,g=d.mapY+a,y=d.owner===undefined?x:w,q=f-y,r=g-y,this.drawWrapped(q,r,2*y,2*y,v,u,function(){this.ctx.moveTo(f+y,g),this.ctx.arc(f,g,y,0,2*Math.PI,!1)}),this.ctx.stroke()}j=this.state.config.label;if(j){i=Math.ceil(Math.max(this.scale,10)/j),this.ctx.save(),this.ctx.translate(a,a),this.ctx.textBaseline="middle",this.ctx.textAlign="center",this.ctx.font="bold "+i+"px Arial",this.ctx.fillStyle="#000",this.ctx.strokeStyle="#fff",this.ctx.lineWidth=.2*i,l=Array(this.state.order.length);for(c=0;c<l.length;c++)l[this.state.order[c]]=c;for(C in this.drawStates){b=this.drawStates[C];for(c=b.length-1;c>=0;c--){d=b[c];if(j===1){if(d.owner===undefined)continue;k=String.fromCharCode(945+l[d.owner])}else k=d.antId;this.ctx.strokeText(k,d.mapX,d.mapY),this.ctx.fillText(k,d.mapX,d.mapY),d.mapX<0&&(this.ctx.strokeText(k,d.mapX+this.map.w,d.mapY),this.ctx.fillText(k,d.mapX+this.map.w,d.mapY),d.mapY<0&&(this.ctx.strokeText(k,d.mapX+this.map.w,d.mapY+this.map.h),this.ctx.fillText(k,d.mapX+this.map.w,d.mapY+this.map.h))),d.mapY<0&&(this.ctx.strokeText(k,d.mapX,d.mapY+this.map.h),this.ctx.fillText(k,d.mapX,d.mapY+this.map.h))}}this.ctx.restore()}this.state.fogPlayer!==undefined&&(f=this.fog.w<v?(v-this.fog.w+1>>1)-this.fog.shiftX:0,g=this.fog.h<u?(u-this.fog.h+1>>1)-this.fog.shiftY:0,this.drawWrapped(f,g,this.fog.w,this.fog.h,this.w,this.h,function(a,b,c,d){a.drawImage(b,c,d)},[this.ctx,this.fog.canvas,f,g]))},K.prototype.setHillImage=function(a){this.hillImage=a},L.extend(E),L.prototype.checkState=function(){if(this.state.shiftX!==this.shiftX||this.state.shiftY!==this.shiftY||this.state.fade!==this.fade||this.state.time!==this.time)this.invalid=!0,this.shiftX=this.state.shiftX,this.shiftY=this.state.shiftY,this.fade=this.state.fade,this.time=this.state.time},L.prototype.draw=function(){var a,b,c,d=this.w-this.antsMap.w>>1,e=this.h-this.antsMap.h>>1,f=d+this.shiftX,g=e+this.shiftY;f-=Math.ceil(f/this.antsMap.w)*this.antsMap.w,g-=Math.ceil(g/this.antsMap.h)*this.antsMap.h;for(a=f;a<this.w;a+=this.antsMap.w)for(b=g;b<this.h;b+=this.antsMap.h)this.ctx.drawImage(this.antsMap.canvas,a,b);if(this.shiftX!==0||this.shiftY!==0){this.ctx.strokeStyle="#000",this.ctx.lineWidth=.5,this.ctx.beginPath();for(a=f;a<=this.w;a+=this.antsMap.w)this.ctx.moveTo(a,0),this.ctx.lineTo(a,this.h);for(b=g;b<=this.h;b+=this.antsMap.h)this.ctx.moveTo(0,b),this.ctx.lineTo(this.w,b);this.ctx.stroke()}this.w>this.antsMap.w&&(f=d+this.antsMap.w,this.ctx.fillStyle="rgba(0,0,0,0.3)",this.ctx.fillRect(0,0,d,this.h),this.ctx.fillRect(f,0,this.w-f,this.h)),this.h>this.antsMap.h&&(g=e+this.antsMap.h,this.ctx.fillStyle="rgba(0,0,0,0.3)",this.ctx.fillRect(0,0,this.w,e),this.ctx.fillRect(0,g,this.w,this.h-g)),this.fade&&(this.ctx.fillStyle=this.fade,this.ctx.fillRect(0,0,this.w,this.h)),c=this.state.replay.meta.replaydata.cutoff,this.time>this.state.replay.duration-1&&c&&(c='"'+c+'"',this.ctx.font=FONT,f=.5*(this.w-this.ctx.measureText(c).width),g=this.h-5,this.ctx.lineWidth=4,this.ctx.strokeStyle="#000",this.ctx.strokeText(c,f,g),this.ctx.fillStyle="#fff",this.ctx.fillText(c,f,g))},M.extend(E),M.prototype.statusToGlyph=function(a){var b=this.state.replay.meta.status[a];return b==="survived"?"✓":b==="eliminated"?"✗":b},M.prototype.checkState=function(){this.duration!==this.state.replay.duration&&this.h>0&&(this.invalid=!0,this.duration=this.state.replay.duration)},M.prototype.draw=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o=this.w-1,p=this.h-1,q=this.state.replay,r=this.getStats(this.stats).values,s=Math.sqrt;this.ctx.fillStyle=SAND_COLOR,this.ctx.fillRect(0,0,this.w,this.h),this.ctx.font="10px Arial,Sans",a=0,b=-Infinity;for(c=0;c<=this.duration;c++)for(d=0;d<r[c].length;d++)b<s(r[c][d])&&(b=s(r[c][d]));f=this.duration===0?0:o/this.duration,this.ctx.strokeStyle="rgba(0,0,0,0.5)",this.ctx.beginPath();for(d=1;d*f<2;)d*=10;for(c=d-1;c<=this.duration+1;c+=d)e=(c+1)%(100*d)?(c+1)%(10*d)?3:7:11,this.ctx.moveTo(.5+f*c,p-e),this.ctx.lineTo(.5+f*c,p+1);this.ctx.moveTo(.5,p+.5),this.ctx.lineTo(.5+f*(this.duration+1),p+.5),this.ctx.stroke(),g=p/(b-a),this.ctx.textAlign="center",m=this.state.replay.meta.replaydata.hills;for(d=0;d<m.length;d++)n=m[d][3]<this.state.replay.duration,n&&r[m[d][3]]&&(i=.5+f*m[d][3],j=.5+g*(b-s(r[m[d][3]][m[d][2]])),this.ctx.fillStyle=q.htmlPlayerColors[m[d][2]],this.ctx.beginPath(),this.ctx.moveTo(i,j),this.ctx.lineTo(i-4,j-8),this.ctx.lineTo(i+4,j-8),this.ctx.lineTo(i,j),this.ctx.fill());this.ctx.textAlign="left";for(c=r[0].length-1;c>=0;c--){this.ctx.strokeStyle=q.htmlPlayerColors[c],this.ctx.beginPath(),this.ctx.moveTo(.5,.5+g*(b-s(r[0][c])));for(d=1;d<=this.duration;d++)this.ctx.lineTo(.5+f*d,.5+g*(b-s(r[d][c])));this.ctx.stroke()}if(!this.state.isStreaming&&q.meta.status)for(c=r[0].length-1;c>=0;c--)d=q.meta.playerturns[c],this.ctx.beginPath(),i=.5+d*f,j=.5+g*(b-s(r[d][c])),this.ctx.moveTo(i,j),h=this.statusToGlyph(c),k=this.ctx.measureText(h).width,l=Math.min(i,o-k),this.ctx.fillStyle=q.htmlPlayerColors[c],this.ctx.strokeStyle=q.htmlPlayerColors[c],j<30?(j=(j+12|0)+.5,this.ctx.lineTo(i,j-8),this.ctx.moveTo(l,j-8),this.ctx.lineTo(l+k,j-8),this.ctx.fillText(h,l,j)):(j=(j-7|0)+.5,this.ctx.lineTo(i,j+2),this.ctx.moveTo(l,j+2),this.ctx.lineTo(l+k,j+2),this.ctx.fillText(h,l,j)),this.ctx.stroke()},M.prototype.getStats=function(a){var b,c=this.state.replay[a];return a==="counts"?b=this.state.replay.scores:(b=Array(c.length),a==="scores"&&this.turn===this.state.replay.duration&&(b[c.length-1]=this.state.replay.meta.replaydata.bonus)),new O(c,b)},N.extend(E),N.MIN_HEIGHT=30,N.MAX_HEIGHT=N.MIN_HEIGHT+70,N.prototype.setSize=function(a,b){E.prototype.setSize.call(this,a,b),this.graph.x=this.x,this.graph.y=this.y+32,this.graph.setSize(a-4,Math.max(0,b-32)),this.showGraph=this.graph.h>0},N.prototype.checkState=function(){if(this.showGraph&&this.time!==this.state.time||this.time!==(this.state.time|0)||this.label!==(this.state.config.label===1))this.invalid=!0,this.time=this.state.time,this.turn=this.time|0,this.label=this.state.config.label===1},N.prototype.draw=function(a){var b,c,d;a&&(this.ctx.fillStyle=BACK_COLOR,this.ctx.strokeStyle=STAT_COLOR,this.ctx.lineWidth=2,e.roundedRect(this.ctx,0,0,this.w,this.h,1,5),this.showGraph&&(this.ctx.moveTo(0,29),this.ctx.lineTo(this.w,29)),this.ctx.fill(),this.ctx.stroke(),this.ctx.font=FONT,this.ctx.textAlign="left",this.ctx.textBaseline="middle",this.ctx.fillStyle=TEXT_COLOR,this.ctx.fillText(this.caption,4,14)),b=this.getStats(this.graph.stats,this.turn),this.drawColorBar(95,2,this.w-97,26,b,this.bonusText),this.showGraph&&(this.ctx.fillStyle=TEXT_GRAPH_COLOR,this.ctx.drawImage(this.graph.canvas,2,30),d=4.5+(this.graph.w-1)*this.time/this.graph.duration,this.ctx.lineWidth=1,this.ctx.beginPath(),this.ctx.moveTo(d,32.5),this.ctx.lineTo(d,32.5+this.graph.h-1),this.ctx.stroke(),c=this.caption+" | ",this.turn===this.graph.duration&&!this.state.isStreaming?c+="end / "+this.graph.duration:c+="turn "+(this.turn+1)+"/"+this.graph.duration,this.ctx.fillText(c,4,44))},N.prototype.getStats=function(a,b){var c=this.state.replay[a][b],d=undefined;return a==="scores"&&this.turn===this.state.replay.duration?d=this.state.replay.meta.replaydata.bonus:a==="counts"&&(d=this.state.replay.stores[b]),new O(c,d)},N.prototype.drawColorBar=function(a,b,c,d,e,f){var g,h,i,j,k,l,m,n=!1,o=Array(e.values.length),p=Array(e.values.length),q=[],r=[],s=0,t=0,u=0,v=a,w=function(e,f,g,h,i,j,l,m){var n,o,p,q,r;e.save();for(n=0;n<h.length;n++)o=j.order[h[n]],e.fillStyle=j.replay.htmlPlayerColors[o],e.strokeStyle=STAT_COLOR,e.lineWidth=.5,g?p=Math.abs(i[o])*f/g:p=f/i.length,p!==0&&(q=Math.ceil(v+p)-v,q=Math.min(a+c-v,q),l?(e.beginPath(),i[o]<0?(e.moveTo(v+q,b),e.lineTo(v,b+d/2),e.lineTo(v+q,b+d),e.closePath()):(e.moveTo(v,b),e.lineTo(v+q,b+d/2),e.lineTo(v,b+d),e.closePath()),e.fill(),e.stroke()):e.fillRect(v,b,q,d),e.textBaseline="middle",e.font="bold 16px Monospace",e.fillStyle=TEXT_COLOR,e.lineWidth=.5,k=i[o],m&&(k=String.fromCharCode(945+n)+" "+k,e.measureText(k).width+4>q&&(k=String.fromCharCode(945+n))),r=e.measureText(k).width+4,r<=q&&(i[o]<0?(e.textAlign="right",e.fillText(k,v+p-2,b+d/2)):(e.textAlign="left",e.fillText(k,v+2,b+d/2))),v+=p);e.restore()};this.ctx.save(),this.ctx.fillStyle=BACK_COLOR,this.ctx.beginPath(),this.ctx.rect(a,b,c,d),this.ctx.fill();for(g=0;g<e.values.length;g++)e.bonus!==undefined&&e.bonus[g]?(o[g]=e.bonus[g],s+=o[g],n=!0):o[g]=0,p[g]=g;i=n?c:c;for(g=0;g<e.values.length;g++)h=this.state.order[g],e.values[h]<0?(q.push(g),t-=e.values[h]):(r.push(g),u+=e.values[h]);l=t+u,m=l+s,q.length&&w(this.ctx,i,m,q,e.values,this.state,!0,this.label),j=a+t*i/m|0,w(this.ctx,i,m,r,e.values,this.state,!1,this.label),this.ctx.lineWidth=2,this.ctx.strokeStyle=STAT_COLOR,this.ctx.beginPath(),n&&(v=Math.ceil(v)+1,this.ctx.moveTo(v,b),this.ctx.lineTo(v,b+d)),q.length&&(this.ctx.moveTo(j,b+2),this.ctx.lineTo(j,b+d-2)),this.ctx.stroke(),this.ctx.fillStyle=TEXT_COLOR,this.ctx.strokeStyle="#fff",this.ctx.font="bold 12px Monospace",this.ctx.textBaseline="top",n&&(v+=1,w(this.ctx,i,m,p,o,this.state,!0,this.label),this.ctx.textAlign="right",this.ctx.strokeText(f,a+c-2,b),this.ctx.fillText(f,a+c-2,b)),this.ctx.restore()}